# Build and test Bun on macOS, Linux, and Windows.
# https://buildkite.com/docs/pipelines/defining-steps
#
# If a step has the `robobun: true` label, robobun will listen
# to webhooks from Buildkite and provision a VM to run the step.
#
# Changes to this file will be automatically uploaded on the next run
# for a particular commit.
steps:
  # Lint
  - key: "bun-lint"
    group: ":broom:"
    steps:
      - key: "bun-lint-zig"
        label: ":broom: lint - zig"
        agents:
          queue: "build-linux"
          os: "linux"
        command:
          - "./scripts/lint.mjs"
        soft_fail:
          - exit_status: 1

  # macOS aarch64
  - key: "bun-darwin-aarch64"
    group: ":darwin: aarch64"
    steps:
      - key: "bun-darwin-aarch64-build-deps"
        label: ":darwin: aarch64 - build-deps"
        agents:
          queue: "build-darwin"
          os: "darwin"
          arch: "aarch64"
        command:
          - "./scripts/build.mjs bun-deps"

      - key: "bun-darwin-aarch64-build-zig"
        label: ":darwin: aarch64 - build-zig"
        agents:
          queue: "build-darwin"
          os: "darwin"
          arch: "aarch64"
        command:
          - "./scripts/build.mjs bun-zig --cross-compile"

      - key: "bun-darwin-aarch64-build-cpp"
        label: ":darwin: aarch64 - build-cpp"
        agents:
          queue: "build-darwin"
          os: "darwin"
          arch: "aarch64"
        command:
          - "./scripts/build.mjs bun-cpp"

      - key: "bun-darwin-aarch64-build-bun"
        label: ":darwin: aarch64 - build-bun"
        depends_on:
          - "bun-darwin-aarch64-build-deps"
          - "bun-darwin-aarch64-build-zig"
          - "bun-darwin-aarch64-build-cpp"
        agents:
          queue: "build-darwin"
          os: "darwin"
          arch: "aarch64"
        command:
          - "./scripts/build.mjs bun-link"

      - key: "bun-darwin-aarch64-test-macos-14"
        label: ":darwin: 14 aarch64 - test-bun"
        if: "build.branch != 'main'"
        parallelism: 3
        soft_fail:
          - exit_status: 2
        retry:
          automatic:
            - exit_status: 1
              limit: 1
            - exit_status: -1
              limit: 3
            - exit_status: 255
              limit: 3
            - signal_reason: agent_stop
              limit: 3
            - signal: SIGTERM
              limit: 3
        depends_on:
          - "bun-darwin-aarch64-build-bun"
        agents:
          queue: "test-darwin"
          os: "darwin"
          arch: "aarch64"
          release: "14"
        command:
          - "./scripts/runner.node.mjs --step bun-darwin-aarch64-build-bun"

      - key: "bun-darwin-aarch64-test-macos-13"
        label: ":darwin: 13 aarch64 - test-bun"
        if: "build.branch != 'main'"
        parallelism: 3
        soft_fail:
          - exit_status: 2
        retry:
          automatic:
            - exit_status: 1
              limit: 1
            - exit_status: -1
              limit: 3
            - exit_status: 255
              limit: 3
            - signal_reason: agent_stop
              limit: 3
            - signal: SIGTERM
              limit: 3
        depends_on:
          - "bun-darwin-aarch64-build-bun"
        agents:
          queue: "test-darwin"
          os: "darwin"
          arch: "aarch64"
          release: "13"
        command:
          - "./scripts/runner.node.mjs --step bun-darwin-aarch64-build-bun"

  # macOS x64
  - key: "bun-darwin-x64"
    group: ":darwin: x64"
    steps:
      - key: "bun-darwin-x64-build-deps"
        label: ":darwin: x64 - build-deps"
        agents:
          queue: "build-darwin"
          os: "darwin"
          arch: "x64"
        command:
          - "./scripts/build.mjs bun-deps"

      - key: "bun-darwin-x64-build-zig"
        label: ":darwin: x64 - build-zig"
        agents:
          queue: "build-darwin"
          os: "darwin"
          arch: "aarch64"
        command:
          - "./scripts/build.mjs bun-zig --cross-compile"

      - key: "bun-darwin-x64-build-cpp"
        label: ":darwin: x64 - build-cpp"
        agents:
          queue: "build-darwin"
          os: "darwin"
          arch: "x64"
        command:
          - "./scripts/build.mjs bun-cpp"

      - key: "bun-darwin-x64-build-bun"
        label: ":darwin: x64 - build-bun"
        depends_on:
          - "bun-darwin-x64-build-deps"
          - "bun-darwin-x64-build-zig"
          - "bun-darwin-x64-build-cpp"
        agents:
          queue: "build-darwin"
          os: "darwin"
          arch: "x64"
        command:
          - "./scripts/build.mjs bun-link"

      - key: "bun-darwin-x64-test-macos-14"
        label: ":darwin: 14 x64 - test-bun"
        if: "build.branch != 'main'"
        parallelism: 2
        soft_fail:
          - exit_status: 2
        retry:
          automatic:
            - exit_status: 1
              limit: 1
            - exit_status: -1
              limit: 3
            - exit_status: 255
              limit: 3
            - signal_reason: agent_stop
              limit: 3
            - signal: SIGTERM
              limit: 3
        depends_on:
          - "bun-darwin-x64-build-bun"
        agents:
          queue: "test-darwin"
          os: "darwin"
          arch: "x64"
          release: "14"
        command:
          - "./scripts/runner.node.mjs --step bun-darwin-x64-build-bun"

      - key: "bun-darwin-x64-test-macos-13"
        label: ":darwin: 13 x64 - test-bun"
        if: "build.branch != 'main'"
        parallelism: 2
        soft_fail:
          - exit_status: 2
        retry:
          automatic:
            - exit_status: 1
              limit: 1
            - exit_status: -1
              limit: 3
            - exit_status: 255
              limit: 3
            - signal_reason: agent_stop
              limit: 3
            - signal: SIGTERM
              limit: 3
        depends_on:
          - "bun-darwin-x64-build-bun"
        agents:
          queue: "test-darwin"
          os: "darwin"
          arch: "x64"
          release: "13"
        command:
          - "./scripts/runner.node.mjs --step bun-darwin-x64-build-bun"

  # Linux aarch64
  - key: "bun-linux-aarch64"
    group: ":linux: aarch64"
    steps:
      - key: "bun-linux-aarch64-build-deps"
        label: ":linux: aarch64 - build-deps"
        agents:
          queue: "build-linux"
          os: "linux"
          arch: "aarch64"
        command:
          - "./scripts/build.mjs bun-deps"

      - key: "bun-linux-aarch64-build-zig"
        label: ":linux: aarch64 - build-zig"
        agents:
          queue: "build-darwin"
          os: "darwin"
          arch: "aarch64"
        command:
          - "./scripts/build.mjs bun-zig --cross-compile"

      - key: "bun-linux-aarch64-build-cpp"
        label: ":linux: aarch64 - build-cpp"
        agents:
          queue: "build-linux"
          os: "linux"
          arch: "aarch64"
        command:
          - "./scripts/build.mjs bun-cpp"

      - key: "bun-linux-aarch64-build-bun"
        label: ":linux: aarch64 - build-bun"
        depends_on:
          - "bun-linux-aarch64-build-deps"
          - "bun-linux-aarch64-build-zig"
          - "bun-linux-aarch64-build-cpp"
        agents:
          queue: "build-linux"
          os: "linux"
          arch: "aarch64"
        command:
          - "./scripts/build.mjs bun-link"

      - key: "bun-linux-aarch64-test-debian-12"
        label: ":debian: 12 aarch64 - test-bun"
        if: "build.branch != 'main'"
        parallelism: 10
        soft_fail:
          - exit_status: 2
        retry:
          automatic:
            - exit_status: 1
              limit: 1
            - exit_status: -1
              limit: 3
            - exit_status: 255
              limit: 3
            - signal_reason: agent_stop
              limit: 3
            - signal: SIGTERM
              limit: 3
        depends_on:
          - "bun-linux-aarch64-build-bun"
        agents:
          robobun: "true"
          os: "linux"
          arch: "aarch64"
          distro: "debian"
          release: "12"
        command:
          - "./scripts/runner.node.mjs --step bun-linux-aarch64-build-bun"

      - key: "bun-linux-aarch64-test-ubuntu-2204"
        label: ":ubuntu: 22.04 aarch64 - test-bun"
        if: "build.branch != 'main'"
        parallelism: 10
        soft_fail:
          - exit_status: 2
        retry:
          automatic:
            - exit_status: 1
              limit: 1
            - exit_status: -1
              limit: 3
            - exit_status: 255
              limit: 3
            - signal_reason: agent_stop
              limit: 3
            - signal: SIGTERM
              limit: 3
        depends_on:
          - "bun-linux-aarch64-build-bun"
        agents:
          robobun: "true"
          os: "linux"
          arch: "aarch64"
          distro: "ubuntu"
          release: "22.04"
        command:
          - "./scripts/runner.node.mjs --step bun-linux-aarch64-build-bun"

      - key: "bun-linux-aarch64-test-ubuntu-2004"
        label: ":ubuntu: 20.04 aarch64 - test-bun"
        if: "build.branch != 'main'"
        parallelism: 10
        soft_fail:
          - exit_status: 2
        retry:
          automatic:
            - exit_status: 1
              limit: 1
            - exit_status: -1
              limit: 3
            - exit_status: 255
              limit: 3
            - signal_reason: agent_stop
              limit: 3
            - signal: SIGTERM
              limit: 3
        depends_on:
          - "bun-linux-aarch64-build-bun"
        agents:
          robobun: "true"
          os: "linux"
          arch: "aarch64"
          distro: "ubuntu"
          release: "20.04"
        command:
          - "./scripts/runner.node.mjs --step bun-linux-aarch64-build-bun"

  # Linux x64
  - key: "bun-linux-x64"
    group: ":linux: x64"
    steps:
      - key: "bun-linux-x64-build-deps"
        label: ":linux: x64 - build-deps"
        agents:
          queue: "build-linux"
          os: "linux"
          arch: "x64"
        command:
          - "./scripts/build.mjs bun-deps"

      - key: "bun-linux-x64-build-zig"
        label: ":linux: x64 - build-zig"
        agents:
          queue: "build-darwin"
          os: "darwin"
          arch: "aarch64"
        command:
          - "./scripts/build.mjs bun-zig --cross-compile"

      - key: "bun-linux-x64-build-cpp"
        label: ":linux: x64 - build-cpp"
        agents:
          queue: "build-linux"
          os: "linux"
          arch: "x64"
        command:
          - "./scripts/build.mjs bun-cpp"

      - key: "bun-linux-x64-build-bun"
        label: ":linux: x64 - build-bun"
        depends_on:
          - "bun-linux-x64-build-deps"
          - "bun-linux-x64-build-zig"
          - "bun-linux-x64-build-cpp"
        agents:
          queue: "build-linux"
          os: "linux"
          arch: "x64"
        command:
          - "./scripts/build.mjs bun-link"

      - key: "bun-linux-x64-test-debian-12"
        label: ":debian: 12 x64 - test-bun"
        if: "build.branch != 'main'"
        parallelism: 10
        soft_fail:
          - exit_status: 2
        retry:
          automatic:
            - exit_status: 1
              limit: 1
            - exit_status: -1
              limit: 3
            - exit_status: 255
              limit: 3
            - signal_reason: agent_stop
              limit: 3
            - signal: SIGTERM
              limit: 3
        depends_on:
          - "bun-linux-x64-build-bun"
        agents:
          robobun: "true"
          os: "linux"
          arch: "x64"
          distro: "debian"
          release: "12"
        command:
          - "./scripts/runner.node.mjs --step bun-linux-x64-build-bun"

      - key: "bun-linux-x64-test-ubuntu-2204"
        label: ":ubuntu: 22.04 x64 - test-bun"
        if: "build.branch != 'main'"
        parallelism: 10
        soft_fail:
          - exit_status: 2
        retry:
          automatic:
            - exit_status: 1
              limit: 1
            - exit_status: -1
              limit: 3
            - exit_status: 255
              limit: 3
            - signal_reason: agent_stop
              limit: 3
            - signal: SIGTERM
              limit: 3
        depends_on:
          - "bun-linux-x64-build-bun"
        agents:
          robobun: "true"
          os: "linux"
          arch: "x64"
          distro: "ubuntu"
          release: "22.04"
        command:
          - "./scripts/runner.node.mjs --step bun-linux-x64-build-bun"

      - key: "bun-linux-x64-test-ubuntu-2004"
        label: ":ubuntu: 20.04 x64 - test-bun"
        if: "build.branch != 'main'"
        parallelism: 10
        soft_fail:
          - exit_status: 2
        retry:
          automatic:
            - exit_status: 1
              limit: 1
            - exit_status: -1
              limit: 3
            - exit_status: 255
              limit: 3
            - signal_reason: agent_stop
              limit: 3
            - signal: SIGTERM
              limit: 3
        depends_on:
          - "bun-linux-x64-build-bun"
        agents:
          robobun: "true"
          os: "linux"
          arch: "x64"
          distro: "ubuntu"
          release: "20.04"
        command:
          - "./scripts/runner.node.mjs --step bun-linux-x64-build-bun"

  # Linux x64-baseline
  - key: "bun-linux-x64-baseline"
    group: ":linux: x64-baseline"
    steps:
      - key: "bun-linux-x64-baseline-build-deps"
        label: ":linux: x64-baseline - build-deps"
        agents:
          queue: "build-linux"
          os: "linux"
          arch: "x64"
        command:
          - "./scripts/build.mjs bun-deps --baseline"

      - key: "bun-linux-x64-baseline-build-zig"
        label: ":linux: x64-baseline - build-zig"
        agents:
          queue: "build-darwin"
          os: "darwin"
          arch: "aarch64"
        command:
          - "./scripts/build.mjs bun-zig --cross-compile"

      - key: "bun-linux-x64-baseline-build-cpp"
        label: ":linux: x64-baseline - build-cpp"
        agents:
          queue: "build-linux"
          os: "linux"
          arch: "x64"
        command:
          - "./scripts/build.mjs bun-cpp"

      - key: "bun-linux-x64-baseline-build-bun"
        label: ":linux: x64-baseline - build-bun"
        depends_on:
          - "bun-linux-x64-baseline-build-deps"
          - "bun-linux-x64-baseline-build-zig"
          - "bun-linux-x64-baseline-build-cpp"
        agents:
          queue: "build-linux"
          os: "linux"
          arch: "x64"
        command:
          - "./scripts/build.mjs bun-link --baseline"

      - key: "bun-linux-x64-baseline-test-debian-12"
        label: ":debian: 12 x64-baseline - test-bun"
        if: "build.branch != 'main'"
        parallelism: 10
        soft_fail:
          - exit_status: 2
        retry:
          automatic:
            - exit_status: 1
              limit: 1
            - exit_status: -1
              limit: 3
            - exit_status: 255
              limit: 3
            - signal_reason: agent_stop
              limit: 3
            - signal: SIGTERM
              limit: 3
        depends_on:
          - "bun-linux-x64-baseline-build-bun"
        agents:
          robobun: "true"
          os: "linux"
          arch: "x64"
          distro: "debian"
          release: "12"
        command:
          - "./scripts/runner.node.mjs --step bun-linux-x64-baseline-build-bun"

      - key: "bun-linux-x64-baseline-test-ubuntu-2204"
        label: ":ubuntu: 22.04 x64-baseline - test-bun"
        if: "build.branch != 'main'"
        parallelism: 10
        soft_fail:
          - exit_status: 2
        retry:
          automatic:
            - exit_status: 1
              limit: 1
            - exit_status: -1
              limit: 3
            - exit_status: 255
              limit: 3
            - signal_reason: agent_stop
              limit: 3
            - signal: SIGTERM
              limit: 3
        depends_on:
          - "bun-linux-x64-baseline-build-bun"
        agents:
          robobun: "true"
          os: "linux"
          arch: "x64"
          distro: "ubuntu"
          release: "22.04"
        command:
          - "./scripts/runner.node.mjs --step bun-linux-x64-baseline-build-bun"

      - key: "bun-linux-x64-baseline-test-ubuntu-2004"
        label: ":ubuntu: 20.04 x64-baseline - test-bun"
        if: "build.branch != 'main'"
        parallelism: 10
        soft_fail:
          - exit_status: 2
        retry:
          automatic:
            - exit_status: 1
              limit: 1
            - exit_status: -1
              limit: 3
            - exit_status: 255
              limit: 3
            - signal_reason: agent_stop
              limit: 3
            - signal: SIGTERM
              limit: 3
        depends_on:
          - "bun-linux-x64-baseline-build-bun"
        agents:
          robobun: "true"
          os: "linux"
          arch: "x64"
          distro: "ubuntu"
          release: "20.04"
        command:
          - "./scripts/runner.node.mjs --step bun-linux-x64-baseline-build-bun"

  # Windows x64
  - key: "bun-windows-x64"
    group: ":windows: x64"
    steps:
      - key: "bun-windows-x64-build-deps"
        label: ":windows: x64 - build-deps"
        agents:
          queue: "build-windows"
          os: "windows"
          arch: "x64"
        env:
          CCACHE_DISABLE: "1"
        command:
          - ".\\scripts\\build.ps1 bun-deps"

      - key: "bun-windows-x64-build-zig"
        label: ":windows: x64 - build-zig"
        agents:
          queue: "build-darwin"
          os: "darwin"
          arch: "aarch64"
        command:
          - "./scripts/build.mjs bun-zig --cross-compile"

      - key: "bun-windows-x64-build-cpp"
        label: ":windows: x64 - build-cpp"
        agents:
          queue: "build-windows"
          os: "windows"
          arch: "x64"
        command:
          - ".\\scripts\\build.ps1 bun-cpp"

      - key: "bun-windows-x64-build-bun"
        label: ":windows: x64 - build-bun"
        depends_on:
          - "bun-windows-x64-build-deps"
          - "bun-windows-x64-build-zig"
          - "bun-windows-x64-build-cpp"
        agents:
          queue: "build-windows"
          os: "windows"
          arch: "x64"
        command:
          - ".\\scripts\\build.ps1 bun-link"

      - key: "bun-windows-x64-test-bun"
        label: ":windows: x64 - test-bun"
        if: "build.branch != 'main'"
        parallelism: 10
        soft_fail:
          - exit_status: 1
        retry:
          automatic:
            - exit_status: -1
              limit: 3
            - exit_status: 255
              limit: 3
            - signal_reason: agent_stop
              limit: 3
            - signal: SIGTERM
              limit: 3
        depends_on:
          - "bun-windows-x64-build-bun"
        agents:
          robobun: "true"
          os: "windows"
          arch: "x64"
        command:
          - "node .\\scripts\\runner.node.mjs --step bun-windows-x64-build-bun"

  # Windows x64-baseline
  - key: "bun-windows-x64-baseline"
    group: ":windows: x64-baseline"
    steps:
      - key: "bun-windows-x64-baseline-build-deps"
        label: ":windows: x64-baseline - build-deps"
        agents:
          queue: "build-windows"
          os: "windows"
          arch: "x64"
        command:
          - ".\\scripts\\build.ps1 bun-deps --baseline"

      - key: "bun-windows-x64-baseline-build-zig"
        label: ":windows: x64-baseline - build-zig"
        agents:
          queue: "build-darwin"
          os: "darwin"
          arch: "aarch64"
        command:
          - "./scripts/build.mjs bun-zig --cross-compile"

      - key: "bun-windows-x64-baseline-build-cpp"
        label: ":windows: x64-baseline - build-cpp"
        agents:
          queue: "build-windows"
          os: "windows"
          arch: "x64"
        command:
          - ".\\scripts\\build.ps1 bun-cpp --baseline"

      - key: "bun-windows-x64-baseline-build-bun"
        label: ":windows: x64-baseline - build-bun"
        depends_on:
          - "bun-windows-x64-baseline-build-deps"
          - "bun-windows-x64-baseline-build-zig"
          - "bun-windows-x64-baseline-build-cpp"
        agents:
          queue: "build-windows"
          os: "windows"
          arch: "x64"
        command:
          - ".\\scripts\\build.ps1 bun-link --baseline"

      - key: "bun-windows-x64-baseline-test-bun"
        label: ":windows: x64-baseline - test-bun"
        if: "build.branch != 'main'"
        parallelism: 10
        soft_fail:
          - exit_status: 1
        retry:
          automatic:
            - exit_status: -1
              limit: 3
            - exit_status: 255
              limit: 3
            - signal_reason: agent_stop
              limit: 3
            - signal: SIGTERM
              limit: 3
        depends_on:
          - "bun-windows-x64-baseline-build-bun"
        agents:
          robobun: "true"
          os: "windows"
          arch: "x64"
        command:
          - "node .\\scripts\\runner.node.mjs --step bun-windows-x64-baseline-build-bun"
