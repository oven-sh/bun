---
type: code
status: in_progress
target_files:
- src/bun.js/bindings/ModuleLoader.cpp
- test/regression/issue/26591.test.ts
model: claude-haiku-4-5-20251001
---
# Fix mock.module to work with process.getBuiltinModule - GitHub #26591

## Problem

`mock.module()` fails to mock modules loaded via `process.getBuiltinModule()`.

## Solution

Add a mock check at the beginning of `resolveAndFetchBuiltinModule()` in `src/bun.js/bindings/ModuleLoader.cpp`.

Before returning any built-in module, check if it's been mocked by calling `Bun::runVirtualModule()`.

```cpp
JSValue resolveAndFetchBuiltinModule(
    Zig::GlobalObject* globalObject,
    BunString* specifier)
{
    // NEW: Check for mocked module first
    bool wasModuleMock = false;
    JSC::JSValue virtualModuleResult = Bun::runVirtualModule(globalObject, specifier, wasModuleMock);
    if (virtualModuleResult) {
        return virtualModuleResult;
    }

    // EXISTING: Continue with normal built-in module resolution...
}
```

## Acceptance Criteria

- [x] Add mock check to `resolveAndFetchBuiltinModule()` in ModuleLoader.cpp
- [x] Create regression test at `test/regression/issue/26591.test.ts`
- [x] Test verifies that `mock.module("node:os", ...)` works with `process.getBuiltinModule("node:os")`
- [x] Run test with `bun bd test test/regression/issue/26591.test.ts` and verify it passes