---
type: task
status: completed
commits:
- f3db0c8c1b
completed_at: 2026-01-30T13:53:49Z
---
# Research: bun create doesn't use registry from bunfig.toml - GitHub #617

## Problem

From issue #617 (July 2022), confirmed by Jarred:

`bun create` was implemented before `bun install` and uses a completely separate code path to download packages/manifest. It doesn't respect:
- Registry settings in bunfig.toml
- `BUN_CONFIG_REGISTRY` environment variable

This is technical debt that causes `bun create` to hang in environments where registry.npmjs.org isn't reachable.

## Solution Approach

1. Find where `bun create` downloads packages/manifests
2. Find where `bun install` reads registry configuration
3. Make `bun create` use the same registry configuration system

## Acceptance Criteria

- [x] Find the bun create package download code path
- [x] Find where registry configuration is read in bun install
- [x] Document what changes are needed to make bun create use the same registry config
- [x] Assess complexity and feasibility

## Research Findings

### 1. bun create Package Download Code Path

**File**: `src/cli/create_command.zig`

The create command has hardcoded npm registry URLs:
- **examples_url** (line 1842): `https://registry.npmjs.org/bun-examples-all/latest`
- **Example.fetch()** (line 2064): Uses `https://registry.npmjs.org/@bun-examples/{name}/latest`
- **Example.fetchAll()** (line 2192): Uses the hardcoded examples_url

These URLs are hardcoded strings with **no consideration** for:
- `bunfig.toml` registry configuration
- `BUN_CONFIG_REGISTRY` environment variable
- `NPM_CONFIG_REGISTRY` environment variable
- `.npmrc` registry settings

### 2. Registry Configuration in bun install

**Primary Files**:
- `src/install/PackageManager/PackageManagerOptions.zig` (lines 412-435)
- `src/bunfig.zig` (lines 551-571)

**Registry Config Hierarchy** (in order of precedence):
1. Command-line arguments (--registry flag)
2. Environment variables:
   - `BUN_CONFIG_REGISTRY`
   - `NPM_CONFIG_REGISTRY`
   - `npm_config_registry`
3. `bunfig.toml` settings:
   - `[install] registry = "url"` for default registry
   - `[install] scopes` section for scoped registries (e.g., @myorg/*)
4. Default: `https://registry.npmjs.org`

**How bun install uses registry**:
- Loads config via `BunArguments.loadConfig()` (PackageManager.zig line 771)
- Reads `config.default_registry` from bunfig.toml (PackageManagerOptions.zig line 252-255)
- Reads scoped registries from `config.scoped` (PackageManagerOptions.zig line 271-277)
- Checks environment variables and sets registry URL (PackageManagerOptions.zig line 412-435)

### 3. Required Changes for bun create

**Location**: `src/cli/create_command.zig` - CreateCommand.exec() function and Example struct

Changes needed:
1. Load `bunfig.toml` configuration in create command (similar to install command)
2. Extract registry resolution logic from PackageManagerOptions.zig into a reusable utility
3. Replace hardcoded URLs in Example.fetch() and Example.fetchAll() with registry configuration
4. Check environment variables before falling back to hardcoded registry
5. Add tests to verify `bun create` respects `BUN_CONFIG_REGISTRY` env var and bunfig.toml settings

**Test locations**:
- `test/cli/create/create-jsx.test.ts`
- `test/cli/install/bun-create.test.ts`

### 4. Complexity Assessment

**Complexity**: Medium

**Feasibility**: High - Registry infrastructure already exists in bun install; needs to be reused in bun create

**Impact**:
- Fixes hanging issues in air-gapped environments
- Makes `bun create` consistent with `bun install` configuration behavior
- Allows users to configure private registries for example templates

**Files to Modify**:
- `src/cli/create_command.zig` (primary)
- `src/install/PackageManager/PackageManagerOptions.zig` (possible refactoring for code reuse)
- `test/cli/install/bun-create.test.ts` (add registry tests)

## Agent Output

2026-01-30T13:53:51Z

```
I'll help you implement this spec to research why `bun create` doesn't use registry from bunfig.toml. Let me start by understanding the current state and planning my approach.
Now let me explore the codebase to find the `bun create` implementation and registry configuration handling.
Excellent! Let me update my progress and document these findings.
Now let me read the spec file and update it with my findings:
Now I'll update the spec with my research findings:
Perfect! Now let me update the spec with the model field and commit the work:
Now let me commit the work:
Perfect! I've successfully completed this research spec. Here's a summary of what I found:

## Research Summary: bun create Registry Configuration

### Key Findings

**The Problem:**
`bun create` has hardcoded npm registry URLs (`https://registry.npmjs.org`) in `src/cli/create_command.zig` (lines 1842, 2064, 2192) and completely ignores:
- `bunfig.toml` registry settings
- `BUN_CONFIG_REGISTRY` environment variable
- `NPM_CONFIG_REGISTRY` environment variable

**Where Registry Works in bun install:**
- `src/install/PackageManager/PackageManagerOptions.zig` handles registry configuration
- `src/bunfig.zig` parses registry settings from bunfig.toml
- Follows a clear hierarchy: CLI args → env vars → bunfig.toml → default

**To Fix bun create:**
1. Extract registry resolution logic into a reusable utility function
2. Load bunfig.toml configuration in the create command (via `BunArguments.loadConfig()`)
3. Replace hardcoded URLs in `Example.fetch()` and `Example.fetchAll()` with registry config
4. Add tests verifying environment variable and bunfig.toml support

### Complexity & Feasibility
- **Complexity**: Medium (fairly straightforward refactoring)
- **Feasibility**: High (infrastructure already exists, just needs reuse)
- **Impact**: Fixes air-gapped environments and makes `bun create` consistent with `bun install`

All acceptance criteria have been documented and the spec has been committed ✅```
