name: Build Linux x64

on:
  workflow_dispatch:
    inputs:
      upload-to-release:
        description: 'Upload binary to existing release tag'
        type: string
        required: false
        default: ''

jobs:
  build:
    name: Build Linux x64
    runs-on: ubuntu-22.04
    env:
      LLVM_VERSION: "19"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install LLVM and dependencies
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh $LLVM_VERSION all
          rm llvm.sh

          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-$LLVM_VERSION 100
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-$LLVM_VERSION 100
          sudo update-alternatives --install /usr/bin/lld lld /usr/bin/lld-$LLVM_VERSION 100
          sudo update-alternatives --install /usr/bin/llvm-ar llvm-ar /usr/bin/llvm-ar-$LLVM_VERSION 100
          sudo ln -sf /usr/bin/lld /usr/bin/ld

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ninja-build \
            libxml2-dev \
            gcc-13 g++-13 \
            libstdc++-13-dev

      - name: Install CMake
        run: |
          CMAKE_VERSION="3.30.5"
          wget -q "https://github.com/Kitware/CMake/releases/download/v${CMAKE_VERSION}/cmake-${CMAKE_VERSION}-linux-x86_64.sh"
          sudo sh cmake-${CMAKE_VERSION}-linux-x86_64.sh --skip-license --prefix=/usr/local
          rm cmake-${CMAKE_VERSION}-linux-x86_64.sh

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
          rustup install nightly
          rustup default nightly
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Build Release
        run: |
          export CC=clang
          export CXX=clang++
          export AR=llvm-ar
          export LD=lld
          bun run build:release

      - name: Prepare artifact
        run: |
          mkdir -p release-artifacts
          cp build/release/bun release-artifacts/bun-linux-x64
          cd release-artifacts
          zip bun-linux-x64.zip bun-linux-x64
          sha256sum bun-linux-x64.zip > bun-linux-x64.zip.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bun-linux-x64
          path: |
            release-artifacts/bun-linux-x64.zip
            release-artifacts/bun-linux-x64.zip.sha256

      - name: Upload to Release
        if: ${{ inputs.upload-to-release != '' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload "${{ inputs.upload-to-release }}" \
            release-artifacts/bun-linux-x64.zip \
            release-artifacts/bun-linux-x64.zip.sha256 \
            --clobber
