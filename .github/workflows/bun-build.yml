name: bun-build

env:
  ZIG_VERSION: 0.12.0-dev.888+130227491

concurrency:
  group: bun-build-${{ github.ref || github.run_id }}
  cancel-in-progress: true

on: [push]
  # push:
  #   branches:
  #     - main
  #     - ci/*
  #   paths:
  #     # Build files
  #     # Source files
  #     - "src/**/*"
  #     - "packages/{bun-usockets,bun-uws}/src/**/*"
  # pull_request:
  #   branches:
  #     - main
  #   paths:
  #     # Build files
  #     - "a"
  #     # Source files
  #     - "src/**/*"
  #     - "packages/{bun-usockets,bun-uws}/src/**/*"
  # workflow_dispatch: {}

permissions:
  contents: read

jobs:
  build:
    name: Build (${{ matrix.id }})
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: linux-x64
            runner: ubuntu-latest
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Restore Cache
        uses: actions/cache@v3
        with:
          key: ${{ runner.os }}-build-${{ matrix.id }}
          path: |
            build
      - name: Setup APT
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          version: "1" # increment when packages change
          packages: |
            make
            cmake
            ccache
            ninja-build
      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}
      - name: Setup LLVM
        uses: KyleMayes/install-llvm-action@v1
        with:
          version: "16"
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Setup Dependencies
        run: |
          bun install
          bun install -g esbuild
      - name: Build
        run: |
          bun run build
          ls
          ls build
