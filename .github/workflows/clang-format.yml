name: clang-format

permissions:
  contents: write

on:
  workflow_call:
  workflow_dispatch:
  pull_request:
    paths:
      - ".github/workflows/clang-format.yml"
      - ".clang-format"
      - "scripts/**"
      - "cmake/**"
      - "src/**.{c,cpp,h,hpp}"

jobs:
  clang-format:
    name: clang-format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github
            .clang-format
            scripts
            cmake
            src
      - name: Setup Bun
        uses: ./.github/actions/setup-bun
        with:
          bun-version: "1.1.25"
      - name: Install LLVM
        run: |
          curl -fsSL https://apt.llvm.org/llvm.sh | sudo bash -s -- 18 all
          sudo apt-get update
          sudo apt-get install -y ccache
      - name: Format
        run: |
          bun run clang-format -DLLVM_VERSION=18.1.8
      - name: Commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Run `bun run clang-format`
