name: clang-format

permissions:
  contents: write

on:
  workflow_call:
  workflow_dispatch:
  pull_request:
    paths:
      - ".github/workflows/clang-format.yml"
      - ".clang-format"
      - "scripts/**"
      - "cmake/**"
      - "src/**.{c,cpp,h,hpp}"

env:
  LLVM_VERSION: "18.1.8"

jobs:
  clang-format:
    name: clang-format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github
            .clang-format
            scripts
            cmake
            src
      - name: Setup Bun
        uses: ./.github/actions/setup-bun
        with:
          bun-version: "1.1.25"
      - name: Setup LLVM
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: ${{ env.LLVM_VERSION }}
      - name: Format
        run: |
          bun run clang-format -DLLVM_VERSION=${{ env.LLVM_VERSION }}
      - name: Commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Run `bun run clang-format` using LLVM ${{ env.LLVM_VERSION }}
