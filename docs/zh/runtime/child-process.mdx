---
title: Spawn
description: ä½¿ç”¨ `Bun.spawn` æˆ– `Bun.spawnSync` ç”Ÿæˆå­è¿›ç¨‹
---

## ç”Ÿæˆè¿›ç¨‹ (`Bun.spawn()`)

æä¾›ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ä½œä¸ºå‘½ä»¤ã€‚`Bun.spawn()` çš„ç»“æœæ˜¯ä¸€ä¸ª `Bun.Subprocess` å¯¹è±¡ã€‚

```ts
const proc = Bun.spawn(["bun", "--version"]);
console.log(await proc.exited); // 0
```

`Bun.spawn` çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå‚æ•°å¯¹è±¡ï¼Œå¯ç”¨äºé…ç½®å­è¿›ç¨‹ã€‚

```ts
const proc = Bun.spawn(["bun", "--version"], {
  cwd: "./path/to/subdir", // æŒ‡å®šå·¥ä½œç›®å½•
  env: { ...process.env, FOO: "bar" }, // æŒ‡å®šç¯å¢ƒå˜é‡
  onExit(proc, exitCode, signalCode, error) {
    // é€€å‡ºå¤„ç†ç¨‹åº
  },
});

proc.pid; // å­è¿›ç¨‹çš„è¿›ç¨‹ ID
```

## è¾“å…¥æµ

é»˜è®¤æƒ…å†µä¸‹ï¼Œå­è¿›ç¨‹çš„è¾“å…¥æµæœªå®šä¹‰ï¼›å¯ä»¥ç”¨ `stdin` å‚æ•°é…ç½®ã€‚

```ts
const proc = Bun.spawn(["cat"], {
  stdin: await fetch("https://raw.githubusercontent.com/oven-sh/bun/main/examples/hashing.js"),
});

const text = await proc.stdout.text();
console.log(text); // "const input = "hello world".repeat(400); ..."
```

| å€¼                       | æè¿°                                           |
| ------------------------ | ---------------------------------------------- |
| `null`                   | **é»˜è®¤å€¼ã€‚** ä¸å‘å­è¿›ç¨‹æä¾›è¾“å…¥                |
| `"pipe"`                 | è¿”å›ä¸€ä¸ª `FileSink` ç”¨äºå¿«é€Ÿå¢é‡å†™å…¥           |
| `"inherit"`              | ç»§æ‰¿çˆ¶è¿›ç¨‹çš„ `stdin`                           |
| `Bun.file()`             | ä»æŒ‡å®šæ–‡ä»¶è¯»å–                                 |
| `TypedArray \| DataView` | ä½¿ç”¨äºŒè¿›åˆ¶ç¼“å†²åŒºä½œä¸ºè¾“å…¥                       |
| `Response`               | ä½¿ç”¨å“åº” `body` ä½œä¸ºè¾“å…¥                       |
| `Request`                | ä½¿ç”¨è¯·æ±‚ `body` ä½œä¸ºè¾“å…¥                       |
| `ReadableStream`         | ä½¿ç”¨å¯è¯»æµä½œä¸ºè¾“å…¥                             |
| `Blob`                   | ä½¿ç”¨ blob ä½œä¸ºè¾“å…¥                             |
| `number`                 | ä»å…·æœ‰ç»™å®šæ–‡ä»¶æè¿°ç¬¦çš„æ–‡ä»¶è¯»å–                 |

`"pipe"` é€‰é¡¹å…è®¸ä»çˆ¶è¿›ç¨‹å‘å­è¿›ç¨‹çš„è¾“å…¥æµå¢é‡å†™å…¥ã€‚

```ts
const proc = Bun.spawn(["cat"], {
  stdin: "pipe", // è¿”å›ä¸€ä¸ªç”¨äºå†™å…¥çš„ FileSink
});

// æ’é˜Ÿå­—ç¬¦ä¸²æ•°æ®
proc.stdin.write("hello");

// æ’é˜ŸäºŒè¿›åˆ¶æ•°æ®
const enc = new TextEncoder();
proc.stdin.write(enc.encode(" world!"));

// å‘é€ç¼“å†²æ•°æ®
proc.stdin.flush();

// å…³é—­è¾“å…¥æµ
proc.stdin.end();
```

å°† `ReadableStream` ä¼ é€’ç»™ `stdin` å…è®¸æ‚¨å°† JavaScript `ReadableStream` çš„æ•°æ®ç›´æ¥ä¼ é€åˆ°å­è¿›ç¨‹çš„è¾“å…¥ï¼š

```ts
const stream = new ReadableStream({
  start(controller) {
    controller.enqueue("Hello from ");
    controller.enqueue("ReadableStream!");
    controller.close();
  },
});

const proc = Bun.spawn(["cat"], {
  stdin: stream,
  stdout: "pipe",
});

const output = await proc.stdout.text();
console.log(output); // "Hello from ReadableStream!"
```

## è¾“å‡ºæµ

æ‚¨å¯ä»¥é€šè¿‡ `stdout` å’Œ `stderr` å±æ€§ä»å­è¿›ç¨‹è¯»å–ç»“æœã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™äº›æ˜¯ `ReadableStream` çš„å®ä¾‹ã€‚

```ts
const proc = Bun.spawn(["bun", "--version"]);
const text = await proc.stdout.text();
console.log(text); // => "1.3.3\n"
```

é€šè¿‡å‘ `stdout/stderr` ä¼ é€’ä»¥ä¸‹å€¼ä¹‹ä¸€æ¥é…ç½®è¾“å‡ºæµï¼š

| å€¼           | æè¿°                                                                 |
| ------------ | ------------------------------------------------------------------- |
| `"pipe"`     | **`stdout` çš„é»˜è®¤å€¼ã€‚** å°†è¾“å‡ºç®¡é“ä¼ è¾“åˆ°è¿”å›çš„ `Subprocess` å¯¹è±¡ä¸Šçš„ `ReadableStream` |
| `"inherit"`  | **`stderr` çš„é»˜è®¤å€¼ã€‚** ä»çˆ¶è¿›ç¨‹ç»§æ‰¿                                |
| `"ignore"`   | ä¸¢å¼ƒè¾“å‡º                                                            |
| `Bun.file()` | å†™å…¥æŒ‡å®šæ–‡ä»¶                                                        |
| `number`     | å†™å…¥å…·æœ‰ç»™å®šæ–‡ä»¶æè¿°ç¬¦çš„æ–‡ä»¶                                          |

## é€€å‡ºå¤„ç†

ä½¿ç”¨ `onExit` å›è°ƒç›‘å¬è¿›ç¨‹é€€å‡ºæˆ–è¢«ç»ˆæ­¢ã€‚

```ts index.ts icon="/icons/typescript.svg"
const proc = Bun.spawn(["bun", "--version"], {
  onExit(proc, exitCode, signalCode, error) {
    // é€€å‡ºå¤„ç†ç¨‹åº
  },
});
```

ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œ`exited` å±æ€§æ˜¯ä¸€ä¸ªåœ¨è¿›ç¨‹é€€å‡ºæ—¶è§£æçš„ `Promise`ã€‚

```ts index.ts icon="/icons/typescript.svg"
const proc = Bun.spawn(["bun", "--version"]);

await proc.exited; // è¿›ç¨‹é€€å‡ºæ—¶è§£æ
proc.killed; // boolean â€” è¿›ç¨‹æ˜¯å¦è¢«ç»ˆæ­¢ï¼Ÿ
proc.exitCode; // null | number
proc.signalCode; // null | "SIGABRT" | "SIGALRM" | ...
```

è¦ç»ˆæ­¢ä¸€ä¸ªè¿›ç¨‹ï¼š

```ts index.ts icon="/icons/typescript.svg"
const proc = Bun.spawn(["bun", "--version"]);
proc.kill();
proc.killed; // true

proc.kill(15); // æŒ‡å®šä¿¡å·ä»£ç 
proc.kill("SIGTERM"); // æŒ‡å®šä¿¡å·åç§°
```

çˆ¶è¿›ç¨‹ `bun` åœ¨æ‰€æœ‰å­è¿›ç¨‹é€€å‡ºä¹‹å‰ä¸ä¼šç»ˆæ­¢ã€‚ä½¿ç”¨ `proc.unref()` å°†å­è¿›ç¨‹ä»çˆ¶è¿›ç¨‹ä¸­åˆ†ç¦»ã€‚

```ts index.ts icon="/icons/typescript.svg"
const proc = Bun.spawn(["bun", "--version"]);
proc.unref();
```

## èµ„æºä½¿ç”¨æƒ…å†µ

æ‚¨å¯ä»¥åœ¨è¿›ç¨‹é€€å‡ºåè·å–æœ‰å…³è¿›ç¨‹èµ„æºä½¿ç”¨æƒ…å†µçš„ä¿¡æ¯ï¼š

```ts index.ts icon="/icons/typescript.svg"
const proc = Bun.spawn(["bun", "--version"]);
await proc.exited;

const usage = proc.resourceUsage();
console.log(`æœ€å¤§å†…å­˜ä½¿ç”¨é‡: ${usage.maxRSS} å­—èŠ‚`);
console.log(`CPU æ—¶é—´ (ç”¨æˆ·): ${usage.cpuTime.user} å¾®ç§’`);
console.log(`CPU æ—¶é—´ (ç³»ç»Ÿ): ${usage.cpuTime.system} å¾®ç§’`);
```

## ä½¿ç”¨ AbortSignal

æ‚¨å¯ä»¥ä½¿ç”¨ `AbortSignal` ä¸­æ­¢å­è¿›ç¨‹ï¼š

```ts index.ts icon="/icons/typescript.svg"
const controller = new AbortController();
const { signal } = controller;

const proc = Bun.spawn({
  cmd: ["sleep", "100"],
  signal,
});

// ç¨åï¼Œä¸­æ­¢è¿›ç¨‹ï¼š
controller.abort();
```

## ä½¿ç”¨ timeout å’Œ killSignal

æ‚¨å¯ä»¥è®¾ç½®å­è¿›ç¨‹åœ¨ç‰¹å®šæŒç»­æ—¶é—´åè‡ªåŠ¨ç»ˆæ­¢çš„è¶…æ—¶ï¼š

```ts index.ts icon="/icons/typescript.svg"
// 5 ç§’åç»ˆæ­¢è¿›ç¨‹
const proc = Bun.spawn({
  cmd: ["sleep", "10"],
  timeout: 5000, // ä»¥æ¯«ç§’ä¸ºå•ä½çš„ 5 ç§’
});

await proc.exited; // å°†åœ¨ 5 ç§’åè§£æ
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œè¶…æ—¶çš„è¿›ç¨‹ä½¿ç”¨ `SIGTERM` ä¿¡å·ç»ˆæ­¢ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ `killSignal` é€‰é¡¹æŒ‡å®šä¸åŒçš„ä¿¡å·ï¼š

```ts index.ts icon="/icons/typescript.svg"
// 5 ç§’åä½¿ç”¨ SIGKILL ç»ˆæ­¢è¿›ç¨‹
const proc = Bun.spawn({
  cmd: ["sleep", "10"],
  timeout: 5000,
  killSignal: "SIGKILL", // å¯ä»¥æ˜¯å­—ç¬¦ä¸²åç§°æˆ–ä¿¡å·ç¼–å·
});
```

`killSignal` é€‰é¡¹è¿˜æ§åˆ¶ AbortSignal è¢«ä¸­æ­¢æ—¶å‘é€çš„ä¿¡å·ã€‚

## ä½¿ç”¨ maxBuffer

å¯¹äº spawnSyncï¼Œæ‚¨å¯ä»¥é™åˆ¶è¿›ç¨‹è¢«ç»ˆæ­¢ä¹‹å‰è¾“å‡ºçš„æœ€å¤§å­—èŠ‚æ•°ï¼š

```ts index.ts icon="/icons/typescript.svg"
// 'yes' è¾“å‡ºè¶…è¿‡ 100 å­—èŠ‚åç»ˆæ­¢å®ƒ
const result = Bun.spawnSync({
  cmd: ["yes"], // æˆ–åœ¨ Windows ä¸Š ["bun", "exec", "yes"]
  maxBuffer: 100,
});
// è¿›ç¨‹é€€å‡º
```

## è¿›ç¨‹é—´é€šä¿¡ (IPC)

Bun æ”¯æŒä¸¤ä¸ª `bun` è¿›ç¨‹ä¹‹é—´çš„ç›´æ¥è¿›ç¨‹é—´é€šä¿¡é€šé“ã€‚è¦ä»ç”Ÿæˆçš„ Bun å­è¿›ç¨‹æ¥æ”¶æ¶ˆæ¯ï¼Œè¯·æŒ‡å®šä¸€ä¸ª `ipc` å¤„ç†ç¨‹åºã€‚

```ts parent.ts icon="/icons/typescript.svg"
const child = Bun.spawn(["bun", "child.ts"], {
  ipc(message) {
    /**
     * ä»å­è¿›ç¨‹æ¥æ”¶åˆ°çš„æ¶ˆæ¯
     **/
  },
});
```

çˆ¶è¿›ç¨‹å¯ä»¥ä½¿ç”¨è¿”å›çš„ `Subprocess` å®ä¾‹ä¸Šçš„ `.send()` æ–¹æ³•å‘å­è¿›ç¨‹å‘é€æ¶ˆæ¯ã€‚å‘é€å­è¿›ç¨‹çš„å¼•ç”¨ä¹Ÿå¯åœ¨ `ipc` å¤„ç†ç¨‹åºä¸­çš„ç¬¬äºŒä¸ªå‚æ•°è·å¾—ã€‚

```ts parent.ts icon="/icons/typescript.svg"
const childProc = Bun.spawn(["bun", "child.ts"], {
  ipc(message, childProc) {
    /**
     * ä»å­è¿›ç¨‹æ¥æ”¶åˆ°çš„æ¶ˆæ¯
     **/
    childProc.send("Respond to child");
  },
});

childProc.send("I am your father"); // çˆ¶è¿›ç¨‹ä¹Ÿå¯ä»¥å‘å­è¿›ç¨‹å‘é€æ¶ˆæ¯
```

åŒæ—¶ï¼Œå­è¿›ç¨‹å¯ä»¥ä½¿ç”¨ `process.send()` å‘å…¶çˆ¶è¿›ç¨‹å‘é€æ¶ˆæ¯ï¼Œå¹¶ä½¿ç”¨ `process.on("message")` æ¥æ”¶æ¶ˆæ¯ã€‚è¿™æ˜¯ä¸ Node.js ä¸­ `child_process.fork()` ç›¸åŒçš„ APIã€‚

```ts child.ts
process.send("Hello from child as string");
process.send({ message: "Hello from child as object" });

process.on("message", message => {
  // ä»çˆ¶è¿›ç¨‹æ‰“å°æ¶ˆæ¯
  console.log(message);
});
```

```ts child.ts
// å‘é€å­—ç¬¦ä¸²
process.send("Hello from child as string");

// å‘é€å¯¹è±¡
process.send({ message: "Hello from child as object" });
```

`serialization` é€‰é¡¹æ§åˆ¶ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´çš„åº•å±‚é€šä¿¡æ ¼å¼ï¼š

- `advanced`: (é»˜è®¤) æ¶ˆæ¯ä½¿ç”¨ JSC `serialize` API åºåˆ—åŒ–ï¼Œæ”¯æŒå…‹éš† [æ‰€æœ‰ `structuredClone` æ”¯æŒçš„å†…å®¹](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm)ã€‚è¿™ä¸æ”¯æŒè½¬ç§»å¯¹è±¡æ‰€æœ‰æƒã€‚
- `json`: æ¶ˆæ¯ä½¿ç”¨ `JSON.stringify` å’Œ `JSON.parse` åºåˆ—åŒ–ï¼Œè¿™ä¸æ”¯æŒåƒ `advanced` é‚£æ ·å¤šçš„å¯¹è±¡ç±»å‹ã€‚

è¦ä»çˆ¶è¿›ç¨‹æ–­å¼€ IPC é€šé“ï¼Œè¯·è°ƒç”¨ï¼š

```ts
childProc.disconnect();
```

### Bun & Node.js é—´çš„ IPC

è¦åœ¨ `bun` è¿›ç¨‹å’Œ Node.js è¿›ç¨‹ä¹‹é—´ä½¿ç”¨ IPCï¼Œåœ¨ `Bun.spawn` ä¸­è®¾ç½® `serialization: "json"`ã€‚è¿™æ˜¯å› ä¸º Node.js å’Œ Bun ä½¿ç”¨ä¸åŒçš„ JavaScript å¼•æ“å’Œä¸åŒçš„å¯¹è±¡åºåˆ—åŒ–æ ¼å¼ã€‚

```js bun-node-ipc.js icon="file-code"
if (typeof Bun !== "undefined") {
  const prefix = `[bun ${process.versions.bun} ğŸ‡]`;
  const node = Bun.spawn({
    cmd: ["node", __filename],
    ipc({ message }) {
      console.log(message);
      node.send({ message: `${prefix} ğŸ‘‹ hey node` });
      node.kill();
    },
    },
    stdio: ["inherit", "inherit", "inherit"],
    serialization: "json",
  });

  node.send({ message: `${prefix} ğŸ‘‹ hey node` });
} else {
  const prefix = `[node ${process.version}]`;
  process.on("message", ({ message }) => {
    console.log(message);
    process.send({ message: `${prefix} ğŸ‘‹ hey bun` });
  });
}
```

---

## ç»ˆç«¯ (PTY) æ”¯æŒ

å¯¹äºäº¤äº’å¼ç»ˆç«¯åº”ç”¨ç¨‹åºï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `terminal` é€‰é¡¹ç”Ÿæˆè¿æ¥åˆ°ä¼ªç»ˆç«¯ (PTY) çš„å­è¿›ç¨‹ã€‚è¿™ä½¿å¾—å­è¿›ç¨‹è®¤ä¸ºå®ƒåœ¨ä¸€ä¸ªçœŸæ­£çš„ç»ˆç«¯ä¸­è¿è¡Œï¼Œå¯ç”¨è¯¸å¦‚å½©è‰²è¾“å‡ºã€å…‰æ ‡ç§»åŠ¨å’Œäº¤äº’å¼æç¤ºç­‰åŠŸèƒ½ã€‚

```ts
const proc = Bun.spawn(["bash"], {
  terminal: {
    cols: 80,
    rows: 24,
    data(terminal, data) {
      // æ¥æ”¶åˆ°æ¥è‡ªç»ˆç«¯çš„æ•°æ®æ—¶è°ƒç”¨
      process.stdout.write(data);
    },
  },
});

// å†™å…¥ç»ˆç«¯
proc.terminal.write("echo hello\n");

// ç­‰å¾…è¿›ç¨‹é€€å‡º
await proc.exited;

// å…³é—­ç»ˆç«¯
proc.terminal.close();
```

å½“æä¾› `terminal` é€‰é¡¹æ—¶ï¼š

- å­è¿›ç¨‹çœ‹åˆ° `process.stdout.isTTY` ä¸º `true`
- `stdin`ã€`stdout` å’Œ `stderr` éƒ½è¿æ¥åˆ°ç»ˆç«¯
- `proc.stdin`ã€`proc.stdout` å’Œ `proc.stderr` è¿”å› `null` â€” è¯·ä½¿ç”¨ç»ˆç«¯ä»£æ›¿
- é€šè¿‡ `proc.terminal` è®¿é—®ç»ˆç«¯

### ç»ˆç«¯é€‰é¡¹

| é€‰é¡¹    | æè¿°                                                                                                       | é»˜è®¤å€¼             |
| ------- | --------------------------------------------------------------------------------------------------------- | ------------------ |
| `cols`  | åˆ—æ•°                                                                                                      | `80`               |
| `rows`  | è¡Œæ•°                                                                                                      | `24`               |
| `name`  | PTY é…ç½®çš„ç»ˆç«¯ç±»å‹ï¼ˆé€šè¿‡ `env` é€‰é¡¹å•ç‹¬è®¾ç½® `TERM` ç¯å¢ƒå˜é‡ï¼‰                                                | `"xterm-256color"` |
| `data`  | æ¥æ”¶æ•°æ®æ—¶çš„å›è°ƒ `(terminal, data) => void`                                                               | â€”                  |
| `exit`  | PTY æµå…³é—­ï¼ˆEOF æˆ–é”™è¯¯ï¼‰æ—¶çš„å›è°ƒã€‚`exitCode` æ˜¯ PTY ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼ˆ0=EOFï¼Œ1=é”™è¯¯ï¼‰ï¼Œä¸æ˜¯å­è¿›ç¨‹é€€å‡ºä»£ç ã€‚ä½¿ç”¨ `proc.exited` è·å–è¿›ç¨‹é€€å‡ºã€‚ | â€”                  |
| `drain` | å‡†å¤‡æ¥æ”¶æ›´å¤šæ•°æ®æ—¶çš„å›è°ƒ `(terminal) => void`                                                             | â€”                  |

### ç»ˆç«¯æ–¹æ³•

`proc.terminal` è¿”å›çš„ `Terminal` å¯¹è±¡å…·æœ‰ä»¥ä¸‹æ–¹æ³•ï¼š

```ts
// å‘ç»ˆç«¯å†™å…¥æ•°æ®
proc.terminal.write("echo hello\n");

// è°ƒæ•´ç»ˆç«¯å¤§å°
proc.terminal.resize(120, 40);

// è®¾ç½®åŸå§‹æ¨¡å¼ï¼ˆç¦ç”¨è¡Œç¼“å†²å’Œå›æ˜¾ï¼‰
proc.terminal.setRawMode(true);

// ç»ˆç«¯æ‰“å¼€æ—¶ä¿æŒäº‹ä»¶å¾ªç¯æ´»è·ƒ
proc.terminal.ref();
proc.terminal.unref();

// å…³é—­ç»ˆç«¯
proc.terminal.close();
```

### å¯é‡ç”¨ç»ˆç«¯

æ‚¨å¯ä»¥ç‹¬ç«‹åˆ›å»ºä¸€ä¸ªç»ˆç«¯å¹¶åœ¨å¤šä¸ªå­è¿›ç¨‹ä¸­é‡ç”¨å®ƒï¼š

```ts
await using terminal = new Bun.Terminal({
  cols: 80,
  rows: 24,
  data(term, data) {
    process.stdout.write(data);
  },
});

// ç”Ÿæˆç¬¬ä¸€ä¸ªè¿›ç¨‹
const proc1 = Bun.spawn(["echo", "first"], { terminal });
await proc1.exited;

// ä¸ºå¦ä¸€ä¸ªè¿›ç¨‹é‡ç”¨ç»ˆç«¯
const proc2 = Bun.spawn(["echo", "second"], { terminal });
await proc2.exited;

// ç»ˆç«¯é€šè¿‡ `await using` è‡ªåŠ¨å…³é—­
```

å½“ä¼ é€’ç°æœ‰ `Terminal` å¯¹è±¡æ—¶ï¼š

- ç»ˆç«¯å¯ä»¥åœ¨å¤šä¸ªç”Ÿæˆä¸­é‡ç”¨
- æ‚¨æ§åˆ¶ä½•æ—¶å…³é—­ç»ˆç«¯
- å½“æ‚¨è°ƒç”¨ `terminal.close()` æ—¶ï¼Œ`exit` å›è°ƒè§¦å‘ï¼Œè€Œä¸æ˜¯åœ¨æ¯ä¸ªå­è¿›ç¨‹é€€å‡ºæ—¶
- ä½¿ç”¨ `proc.exited` æ£€æµ‹å„ä¸ªå­è¿›ç¨‹çš„é€€å‡º

è¿™å¯¹äºé€šè¿‡åŒä¸€ç»ˆç«¯ä¼šè¯æŒ‰é¡ºåºè¿è¡Œå¤šä¸ªå‘½ä»¤å¾ˆæœ‰ç”¨ã€‚

<Note>ç»ˆç«¯æ”¯æŒä»…åœ¨ POSIX ç³»ç»Ÿï¼ˆLinuxã€macOSï¼‰ä¸Šå¯ç”¨ã€‚åœ¨ Windows ä¸Šä¸å¯ç”¨ã€‚</Note>

---

## é˜»å¡ API (`Bun.spawnSync()`)

Bun æä¾›äº† `Bun.spawn` çš„åŒæ­¥ç­‰ä»·ç‰© `Bun.spawnSync`ã€‚è¿™æ˜¯ä¸€ä¸ªé˜»å¡ APIï¼Œæ”¯æŒä¸ `Bun.spawn` ç›¸åŒçš„è¾“å…¥å’Œå‚æ•°ã€‚å®ƒè¿”å›ä¸€ä¸ª `SyncSubprocess` å¯¹è±¡ï¼Œå®ƒåœ¨å‡ ä¸ªæ–¹é¢ä¸ `Subprocess` ä¸åŒã€‚

1. å®ƒåŒ…å«ä¸€ä¸ª `success` å±æ€§ï¼ŒæŒ‡ç¤ºè¿›ç¨‹æ˜¯å¦ä»¥é›¶é€€å‡ºä»£ç é€€å‡ºã€‚
2. `stdout` å’Œ `stderr` å±æ€§æ˜¯ `Buffer` çš„å®ä¾‹ï¼Œè€Œä¸æ˜¯ `ReadableStream`ã€‚
3. æ²¡æœ‰ `stdin` å±æ€§ã€‚ä½¿ç”¨ `Bun.spawn` å¢é‡å†™å…¥å­è¿›ç¨‹çš„è¾“å…¥æµã€‚

```ts
const proc = Bun.spawnSync(["echo", "hello"]);

console.log(proc.stdout.toString());
// => "hello\n"
```

ä½œä¸ºç»éªŒæ³•åˆ™ï¼Œå¼‚æ­¥ `Bun.spawn` API æ›´é€‚åˆ HTTP æœåŠ¡å™¨å’Œåº”ç”¨ç¨‹åºï¼Œè€Œ `Bun.spawnSync` æ›´é€‚åˆæ„å»ºå‘½ä»¤è¡Œå·¥å…·ã€‚

---

## åŸºå‡†æµ‹è¯•

<Note>
  âš¡ï¸ åœ¨åº•å±‚ï¼Œ`Bun.spawn` å’Œ `Bun.spawnSync` ä½¿ç”¨
  [`posix_spawn(3)`](https://man7.org/linux/man-pages/man3/posix_spawn.3.html)ã€‚
</Note>

Bun çš„ `spawnSync` æ¯” Node.js çš„ `child_process` æ¨¡å—å¿« 60% åœ°ç”Ÿæˆè¿›ç¨‹ã€‚

```bash terminal icon="terminal"
bun spawn.mjs
```

```txt
cpu: Apple M1 Max
runtime: bun 1.x (arm64-darwin)

benchmark              time (avg)             (min â€¦ max)       p75       p99      p995
--------------------------------------------------------- -----------------------------
spawnSync echo hi  888.14 Âµs/iter    (821.83 Âµs â€¦ 1.2 ms) 905.92 Âµs      1 ms   1.03 ms
```

```sh terminal icon="terminal"
node spawn.node.mjs
```

```txt
cpu: Apple M1 Max
runtime: node v18.9.1 (arm64-darwin)

benchmark              time (avg)             (min â€¦ max)       p75       p99      p995
--------------------------------------------------------- -----------------------------
spawnSync echo hi    1.47 ms/iter     (1.14 ms â€¦ 2.64 ms)   1.57 ms   2.37 ms   2.52 ms
```

---

## å‚è€ƒ

ä¸‹é¢æ˜¾ç¤ºäº† Spawn API å’Œç±»å‹çš„å‚è€ƒã€‚çœŸå®ç±»å‹å…·æœ‰å¤æ‚çš„æ³›å‹ï¼Œä»¥ä½¿ç”¨ä¼ é€’ç»™ `Bun.spawn` å’Œ `Bun.spawnSync` çš„é€‰é¡¹å¼ºç±»å‹åŒ– `Subprocess` æµã€‚æœ‰å…³å®Œæ•´è¯¦ç»†ä¿¡æ¯ï¼Œè¯·åœ¨ [bun.d.ts](https://github.com/oven-sh/bun/blob/main/packages/bun-types/bun.d.ts) ä¸­æŸ¥æ‰¾è¿™äº›ç±»å‹çš„å®šä¹‰ã€‚

```ts å‚è§ TypeScript å®šä¹‰ expandable
interface Bun {
  spawn(command: string[], options?: SpawnOptions.OptionsObject): Subprocess;
  spawnSync(command: string[], options?: SpawnOptions.OptionsObject): SyncSubprocess;

  spawn(options: { cmd: string[] } & SpawnOptions.OptionsObject): Subprocess;
  spawnSync(options: { cmd: string[] } & SpawnOptions.OptionsObject): SyncSubprocess;
}

namespace SpawnOptions {
  interface OptionsObject {
    cwd?: string;
    env?: Record<string, string | undefined>;
    stdio?: [Writable, Readable, Readable];
    stdin?: Writable;
    stdout?: Readable;
    stderr?: Readable;
    onExit?(
      subprocess: Subprocess,
      exitCode: number | null,
      signalCode: number | null,
      error?: ErrorLike,
    ): void | Promise<void>;
    ipc?(message: any, subprocess: Subprocess): void;
    serialization?: "json" | "advanced";
    windowsHide?: boolean;
    windowsVerbatimArguments?: boolean;
    argv0?: string;
    signal?: AbortSignal;
    timeout?: number;
    killSignal?: string | number;
    maxBuffer?: number;
    terminal?: TerminalOptions; // PTY æ”¯æŒï¼ˆä»… POSIXï¼‰
  }

  type Readable =
    | "pipe"
    | "inherit"
    | "ignore"
    | null // ç­‰åŒäº "ignore"
    | undefined // ä½¿ç”¨é»˜è®¤å€¼
    | BunFile
    | ArrayBufferView
    | number;

  type Writable =
    | "pipe"
    | "inherit"
    | "ignore"
    | null // ç­‰åŒäº "ignore"
    | undefined // ä½¿ç”¨é»˜è®¤å€¼
    | BunFile
    | ArrayBufferView
    | number
    | ReadableStream
    | Blob
    | Response
    | Request;
}

interface Subprocess extends AsyncDisposable {
  readonly stdin: FileSink | number | undefined | null;
  readonly stdout: ReadableStream<Uint8Array<ArrayBuffer>> | number | undefined | null;
  readonly stderr: ReadableStream<Uint8Array<ArrayBuffer>> | number | undefined | null;
  readonly readable: ReadableStream<Uint8Array<ArrayBuffer>> | number | undefined | null;
  readonly terminal: Terminal | undefined;
  readonly pid: number;
  readonly exited: Promise<number>;
  readonly exitCode: number | null;
  readonly signalCode: NodeJS.Signals | null;
  readonly killed: boolean;

  kill(exitCode?: number | NodeJS.Signals): void;
  ref(): void;
  unref(): void;

  send(message: any): void;
  disconnect(): void;
  resourceUsage(): ResourceUsage | undefined;
}

interface SyncSubprocess {
  stdout: Buffer | undefined;
  stderr: Buffer | undefined;
  exitCode: number;
  success: boolean;
  resourceUsage: ResourceUsage;
  signalCode?: string;
  exitedDueToTimeout?: true;
  pid: number;
}

interface TerminalOptions {
  cols?: number;
  rows?: number;
  name?: string;
  data?: (terminal: Terminal, data: Uint8Array<ArrayBuffer>) => void;
  /** PTY æµå…³é—­ï¼ˆEOF æˆ–é”™è¯¯ï¼‰æ—¶è°ƒç”¨ã€‚exitCode æ˜¯ PTY ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼ˆ0=EOFï¼Œ1=é”™è¯¯ï¼‰ï¼Œä¸æ˜¯å­è¿›ç¨‹é€€å‡ºä»£ç ã€‚ */
  exit?: (terminal: Terminal, exitCode: number, signal: string | null) => void;
  drain?: (terminal: Terminal) => void;
}

interface Terminal extends AsyncDisposable {
  readonly stdin: number;
  readonly stdout: number;
  readonly closed: boolean;
  write(data: string | BufferSource): number;
  resize(cols: number, rows: number): void;
  setRawMode(enabled: boolean): void;
  ref(): void;
  unref(): void;
  close(): void;
}

interface ResourceUsage {
  contextSwitches: {
    voluntary: number;
    involuntary: number;
  };

  cpuTime: {
    user: number;
    system: number;
    total: number;
  };
  maxRSS: number;

  messages: {
    sent: number;
    received: number;
  };
  ops: {
    in: number;
    out: number;
  };
  shmSize: number;
  signalCount: number;
  swapCount: number;
}

type Signal =
  | "SIGABRT"
  | "SIGALRM"
  | "SIGBUS"
  | "SIGCHLD"
  | "SIGCONT"
  | "SIGFPE"
  | "SIGHUP"
  | "SIGILL"
  | "SIGINT"
  | "SIGIO"
  | "SIGIOT"
  | "SIGKILL"
  | "SIGPIPE"
  | "SIGPOLL"
  | "SIGPROF"
  | "SIGPWR"
  | "SIGQUIT"
  | "SIGSEGV"
  | "SIGSTKFLT"
  | "SIGSTOP"
  | "SIGSYS"
  | "SIGTERM"
  | "SIGTRAP"
  | "SIGTSTP"
  | "SIGTTIN"
  | "SIGTTOU"
  | "SIGUNUSED"
  | "SIGURG"
  | "SIGUSR1"
  | "SIGUSR2"
  | "SIGVTALRM"
  | "SIGWINCH"
  | "SIGXCPU"
  | "SIGXFSZ"
  | "SIGBREAK"
  | "SIGLOST"
  | "SIGINFO";
```
