# Agent Context: OpenTelemetry Support for Bun

**Purpose**: This file helps AI agents quickly understand the OpenTelemetry implementation for Bun without re-reading all documentation.

**Last Updated**: 2025-10-20
**Status**: Phase 1 (Design) Complete
**Branch**: `feat/open-telemetry`

---

## Quick Summary

Bun's OpenTelemetry support provides **native Zig-layer instrumentation hooks** for distributed tracing, metrics, and logging - achieving 10x performance improvement over traditional monkey-patching approaches. The implementation is designed as a **drop-in replacement for `@opentelemetry/sdk-node`** while using Bun-specific optimizations.

**Key Innovation**: `attach/detach` API allows TypeScript instrumentation packages to register hooks for operation lifecycle events (HTTP, Fetch, SQL, Redis, S3), receiving semantic convention attributes directly from Zig layer.

---

## Architecture at a Glance

```
┌─────────────────────────────────────────────────────┐
│  User Application                                    │
│  (Uses @opentelemetry/api + BunSDK)                 │
└─────────────────┬───────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────┐
│  packages/bun-otel (TypeScript)                      │
│  - BunSDK (wraps NodeSDK)                           │
│  - BunHttpInstrumentation                            │
│  - BunFetchInstrumentation                           │
│  - Calls Bun.telemetry.attach()                     │
└─────────────────┬───────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────┐
│  src/bun.js/telemetry.zig (Native Layer)            │
│  - InstrumentKind enum (http, fetch, sql, etc.)     │
│  - Telemetry singleton (instrument registry)        │
│  - attach/detach API                                 │
│  - AttributeMap (MVP: Zig wrapper around JSValue)   │
└─────────────────┬───────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────┐
│  Integration Points (Zig)                            │
│  - src/bun.js/api/server.zig (Bun.serve)            │
│  - src/bun.js/webcore/fetch.zig (fetch)             │
│  - Future: SQL, Redis, S3                            │
└──────────────────────────────────────────────────────┘
```

---

## Critical Design Decisions

### 1. Native Hooks vs Monkey-Patching

**Decision**: Use Zig-layer hooks inserted at operation lifecycle points
**Rationale**: 10x performance improvement validated in POC
**Trade-off**: Requires Bun core changes vs framework-agnostic instrumentation

### 2. Attach/Detach Model

**Decision**: Extensible registration API replacing monolithic `configure()`
**Rationale**: Supports multiple concurrent instrumentations, cleaner separation of concerns
**Implementation**: `Bun.telemetry.attach(NativeInstrument): number` → `Bun.telemetry.detach(id)`

### 3. Semantic Convention Attributes in Zig

**Decision**: Zig builds `AttributeMap` with OpenTelemetry semconv keys, TypeScript receives plain objects
**Rationale**:
- TypeScript sees `{ "http.request.method": "GET" }` - ready for `span.setAttributes()`
- No conversion layer needed
- Future optimization path via native AttributeMap C++ class

### 4. MVP AttributeMap (Not Full Optimization)

**Decision**: Zig wrapper around JSValue that simulates `fastSet`/`fastGet` internally
**Rationale**:
- Focus on **correctness** first
- Avoid GPERF codegen scope creep
- Future story explores 10x performance optimization with native C++ AttributeMap
- API commitment: Zig call sites won't change when optimization lands

### 5. BunSDK Wraps NodeSDK

**Decision**: BunSDK extends NodeSDK, auto-includes Bun instrumentations
**Rationale**: Maximum compatibility with existing examples, minimal migration effort

---

## Implementation Status (from POC/existing work)

**✅ Completed (feat/opentelemetry-server-hooks branch)**:
- P1: HTTP server tracing (Bun.serve)
- P1: Fetch client tracing
- P2: HTTP metrics (request count, duration histogram)
- Native hooks integration points
- AsyncLocalStorage context propagation (Zig controls initial stack frame)

**🚧 In Progress (this spec)**:
- Refactor: configure() → attach/detach model
- AttributeMap MVP implementation
- BunSDK wrapper
- Documentation and examples

**📋 Planned (P3)**:
- Logging integration helpers (Pino/Winston formatters)
- Additional instrumentation kinds (SQL, Redis, S3)

---

## Key Files and Locations

### Specification Documents (This Directory)
- `spec.md` - Feature requirements, user stories, success criteria
- `plan.md` - Implementation plan, constitution check, project structure
- `research.md` - Architectural decisions, lessons learned from POC
- `data-model.md` - Core entities, lifecycle models, AttributeMap design
- `quickstart.md` - Developer getting-started guide
- `contracts/bun-telemetry-api.md` - Core attach/detach API specification
- `contracts/hook-lifecycle.md` - Detailed hook specifications, attributes, corner cases

### Source Code (To Be Implemented)
```
src/bun.js/
├── telemetry.zig                    # Core attach/detach, InstrumentKind
├── telemetry_http.zig               # HTTP-specific hooks and attributes
├── api/server/RequestContext.zig    # Bun.serve() integration
└── webcore/fetch.zig                # fetch() client instrumentation

packages/bun-otel/
├── src/
│   ├── index.ts                     # Main exports
│   ├── BunSDK.ts                    # NodeSDK wrapper
│   ├── instruments/
│   │   ├── BunHttpInstrumentation.ts
│   │   ├── BunFetchInstrumentation.ts
│   │   └── BunMetricsInstrumentation.ts
│   └── context/AsyncContextManager.ts
├── test/                            # Unit tests (CAN import @opentelemetry/*)
└── examples/                        # Working examples

test/js/bun/telemetry/               # Native API tests (NO @opentelemetry/*)
test/integration/opentelemetry/      # Integration tests with backends
```

### Reference Implementation
```
~/github/worktree/bun-fork-old/      # POC branch with working code
BRANCH_SUMMARY.md                     # Development history
contracts/bun-telemetry-api.md        # Native API specification (attach/detach)
data-model.md                         # Core data structures and lifecycle
TEST_STRATEGY.md                      # Test separation philosophy
```

---

## API Contract Summary

### Bun.telemetry.attach(instrument: NativeInstrument): number

```typescript
interface NativeInstrument {
  type: InstrumentKind;  // http, fetch, sql, redis, s3, custom
  name: string;
  version: string;

  captureAttributes?: {
    requestHeaders?: string[];   // Allowlist (deny-by-default)
    responseHeaders?: string[];
  };

  // All hooks receive semantic convention attributes
  onOperationStart?: (id: number, attributes: Record<string, any>) => void;
  onOperationProgress?: (id: number, attributes: Record<string, any>) => void;
  onOperationEnd?: (id: number, attributes: Record<string, any>) => void;
  onOperationError?: (id: number, attributes: Record<string, any>) => void;
  onOperationInject?: (id: number) => Record<string, string> | void;
}
```

### Attribute Examples

**HTTP Server (onOperationStart)**:
```typescript
{
  "operation.id": 123,
  "operation.timestamp": 1698765432123456789,
  "http.request.method": "GET",
  "url.full": "http://localhost:3000/api/users?limit=10",
  "url.path": "/api/users",
  "url.query": "limit=10",
  "server.address": "localhost",
  "server.port": 3000,
  "http.request.header.content-type": "application/json",  // if configured
  "trace.parent.trace_id": "0af7651916cd43dd...",          // if traceparent header present
}
```

**HTTP Server (onOperationEnd)**:
```typescript
{
  "http.response.status_code": 200,
  "http.response.body.size": 4567,
  "operation.duration": 12345678,  // nanoseconds
  "http.response.header.content-type": "application/json",
}
```

---

## Testing Strategy

### Three-Layer Separation

1. **Native Hook Tests** (`test/js/bun/telemetry/`)
   - Test ONLY `Bun.telemetry.*` API
   - NO `@opentelemetry/*` imports
   - Verify hooks called with correct attributes
   - TDD workflow: `USE_SYSTEM_BUN=1 bun test` (fail) → implement → `bun bd test` (pass)

2. **Package Tests** (`packages/bun-otel/test/`)
   - Test TypeScript instrumentation layer
   - CAN import `@opentelemetry/*`
   - Verify spans created with correct semantic conventions
   - Test distributed tracing, header propagation

3. **Integration Tests** (`test/integration/opentelemetry/`)
   - Standalone projects (own package.json)
   - End-to-end with real backends (Jaeger, Zipkin, OTLP collector)
   - Docker Compose for dependencies

---

## Performance Characteristics

**Targets** (from constitution and research):
- Disabled: <0.1% overhead (~5ns per request)
- Enabled: <5% overhead (~1.3μs attribute building + hook calls)
- POC validated: ~4.5% overhead vs ~15-20% with monkey-patching

**Memory**:
- Per instrument: ~160 bytes
- Per request: ~700 bytes (span + attributes)
- Bounded growth (maps cleaned on completion)

---

## Common Pitfalls and Gotchas

### 1. Memory Leaks in Instrumentations

**Problem**: Forgetting to delete spans from map
```typescript
// ❌ WRONG
onOperationEnd(id, attributes) {
  const span = this.spans.get(id);
  span.end();
  // LEAK: span still in map!
}

// ✅ CORRECT
onOperationEnd(id, attributes) {
  const span = this.spans.get(id);
  span.end();
  this.spans.delete(id);  // CRITICAL
}
```

### 2. Header Blocklist Security

**Always blocked** (even if in allowlist):
- authorization
- cookie / set-cookie
- api-key / x-api-key
- session tokens

### 3. Attribute Keys vs Custom Objects

**Wrong**: Passing custom TypeScript interfaces
```typescript
// ❌ WRONG
info.method → span.setAttribute("method", info.method)
```

**Correct**: Zig provides semantic convention keys
```typescript
// ✅ CORRECT
attributes["http.request.method"] → span.setAttributes(attributes)
```

### 4. AsyncLocalStorage Context

**Not a Problem in Bun**: POC already solved this
- Zig controls initial AsyncLocalStorage stack frame for request handlers
- No workaround needed (`context.with()` works fine)
- Context flows through `await`, `setTimeout`, promises correctly

### 5. InstrumentKind Values

**Enum values are fixed**:
- custom = 0
- http = 1
- fetch = 2
- sql = 3
- redis = 4
- s3 = 5 (NOT "aws" - S3 only)

---

## Migration from configure() API (Existing Code)

**Old (deprecated)**:
```typescript
Bun.telemetry.configure({
  http: {
    onStart: (info) => { /* ... */ },
    onEnd: (result) => { /* ... */ },
  },
});
```

**New (attach/detach)**:
```typescript
const id = Bun.telemetry.attach({
  type: InstrumentKind.HTTP,
  name: "my-instrumentation",
  version: "1.0.0",
  onOperationStart: (id, attributes) => { /* ... */ },
  onOperationEnd: (id, attributes) => { /* ... */ },
});

// Later: cleanup
Bun.telemetry.detach(id);
```

---

## NodeSDK Compatibility Checklist

BunSDK must support:
- ✅ All NodeSDKConfiguration options
- ✅ Environment variable configuration (OTEL_*)
- ✅ start() / shutdown() lifecycle
- ✅ Resource detection
- ✅ Custom propagators
- ✅ Custom samplers
- ✅ Span processors
- ✅ Metric readers
- ✅ Log record processors

**Key Difference**: BunSDK auto-registers Bun instrumentations, NodeSDK requires manual `getNodeAutoInstrumentations()`

---

## Future Optimization: Native AttributeMap

**Current (MVP)**: Zig wrapper around JSValue
```zig
pub const AttributeMap = struct {
    value: JSValue,  // Plain JS object
    // fastSet/fastGet do string lookups internally
};
```

**Future**: C++ AttributeMap with perfect hash (see `attributes-api-research.md`)
- GPERF-generated perfect hash for semantic conventions
- Numeric enums 0-254 for O(1) lookups
- Hybrid storage: array + HashMap
- Expected 10x improvement for attribute-heavy workloads
- **Deferred to separate story** - implementation maintains API compatibility

---

## Questions for Future Developers

1. **Adding new InstrumentKind**: Update enum in both Zig and TypeScript, ensure values never reused
2. **Custom attributes**: Use direct `value.put()` on AttributeMap, bypassing enum
3. **Performance regression**: Check exporter config (batch vs simple), header capture count, sampling rate
4. **Span not linked**: Verify AsyncLocalStorage context (should work - POC validated)
5. **Header not captured**: Check allowlist configuration and blocklist (security)

---

## Related External Resources

- [OpenTelemetry HTTP Semantic Conventions](https://opentelemetry.io/docs/specs/semconv/http/http-spans/)
- [W3C TraceContext Specification](https://www.w3.org/TR/trace-context/)
- [OpenTelemetry Node.js Getting Started](https://opentelemetry.io/docs/languages/js/getting-started/nodejs/)
- [OpenTelemetry Attributes Specification](https://opentelemetry.io/docs/specs/otel/common/attribute-naming/)

---

## Change Log

### 2025-10-20: Phase 1 Design Complete
- Created spec.md, plan.md, research.md, data-model.md
- Documented attach/detach API contracts
- Created quickstart guide
- Clarified MVP AttributeMap vs future optimization
- Defined S3 (not AWS) instrumentation kind
