var C=function(A){return g.test(A)},m=function(A){return d.test(A)},L=function(A){if(C(A))return 4;if(m(A))return 6;return 0},i=function(A,N,V){if(typeof N=="function")V=N,N=void 0;var Z=typeof A=="object"?A:{host:N,port:A};return new p(Z).connect(Z,V)},l=function(A,N){A.emit("error",N)},c=function(A,N){if(typeof N==="function")try{N()}catch(V){A.emit("error",V)}A.emit("listening")},n=function(A,N){return new k(A,N)},w="(?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])",x="((?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])[.]){3}(?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])",g=new RegExp("^((?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])[.]){3}(?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])$"),P="(?:[0-9a-fA-F]{1,4})",d=new RegExp("^((?:(?:[0-9a-fA-F]{1,4}):){7}(?:(?:[0-9a-fA-F]{1,4})|:)|(?:(?:[0-9a-fA-F]{1,4}):){6}(?:((?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])[.]){3}(?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])|:(?:[0-9a-fA-F]{1,4})|:)|(?:(?:[0-9a-fA-F]{1,4}):){5}(?::((?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])[.]){3}(?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])|(:(?:[0-9a-fA-F]{1,4})){1,2}|:)|(?:(?:[0-9a-fA-F]{1,4}):){4}(?:(:(?:[0-9a-fA-F]{1,4})){0,1}:((?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])[.]){3}(?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])|(:(?:[0-9a-fA-F]{1,4})){1,3}|:)|(?:(?:[0-9a-fA-F]{1,4}):){3}(?:(:(?:[0-9a-fA-F]{1,4})){0,2}:((?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])[.]){3}(?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])|(:(?:[0-9a-fA-F]{1,4})){1,4}|:)|(?:(?:[0-9a-fA-F]{1,4}):){2}(?:(:(?:[0-9a-fA-F]{1,4})){0,3}:((?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])[.]){3}(?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])|(:(?:[0-9a-fA-F]{1,4})){1,5}|:)|(?:(?:[0-9a-fA-F]{1,4}):){1}(?:(:(?:[0-9a-fA-F]{1,4})){0,4}:((?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])[.]){3}(?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])|(:(?:[0-9a-fA-F]{1,4})){1,6}|:)|(?::((?::(?:[0-9a-fA-F]{1,4})){0,5}:((?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])[.]){3}(?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])|(?::(?:[0-9a-fA-F]{1,4})){1,7}|:)))(%[0-9a-zA-Z-.:]{1,})?$"),{Bun:b,createFIFO:h,Object:I}=import.meta.primordials,{connect:v}=b,{Duplex:f}=import.meta.require("node:stream"),{EventEmitter:u}=import.meta.require("node:events"),{setTimeout:E}=globalThis,S=Symbol.for("::buntls::"),y=Symbol.for("::bunsocket_serverhandlers::"),H=Symbol.for("::bunnetserverconnections::"),T=Symbol.for("::bunnetserveroptions::"),_,p=function(A){return _=A,I.defineProperty(_.prototype,Symbol.toStringTag,{value:"Socket",enumerable:!1}),I.defineProperty(function N(V){return new A(V)},Symbol.hasInstance,{value(N){return N instanceof A}})}(class A extends f{static#A={close:A.#N,connectError(N,V){N.data.emit("error",V)},data({data:N},V){N.bytesRead+=V.length;const Z=N.#G;if(Z.isEmpty()){if(N.push(V))return}Z.push(V)},drain:A.#V,end:A.#N,error(N,V){const Z=N.data,G=Z.#K;if(G)Z.#K=null,G(V);Z.emit("error",V)},open(N){const V=N.data;N.timeout(V.timeout),N.ref(),V.#J=N,V.connecting=!1,V.emit("connect",V),A.#V(N)},handshake(N,V,Z){const{data:G}=N;if(G._securePending=!1,G.secureConnecting=!1,G._secureEstablished=!!V,G._requestCert||G._rejectUnauthorized){if(Z){if(G.authorized=!1,G.authorizationError=Z.code||Z.message,G._rejectUnauthorized){G.destroy(Z);return}}}else G.authorized=!0;G.emit("secureConnect",Z)},timeout(N){const V=N.data;V.emit("timeout",V)},binaryType:"buffer"};static#N(N){const V=N.data;if(V.#Z)return;V.#Z=!0,V.#J=null;const Z=V.#G;if(Z.isEmpty()){if(V.push(null))return}Z.push(null)}static#V(N){const V=N.data,Z=V.#K;if(Z){const G=V.#M,J=N.write(G);if(V.bytesWritten+=J,J<G.length)V.#M=G.slice(J);else V.#K=null,V.#M=null,Z(null)}}static[y]={data:A.#A.data,close(N){A.#A.close(N),this.data[H]--},end(N){A.#A.end(N),this.data[H]--},open(N){const V=this.data,Z=V[T],{pauseOnConnect:G,connectionListener:J,InternalSocketClass:K,requestCert:M,rejectUnauthorized:W}=Z,X=new K({});if(X.isServer=!0,X._requestCert=M,X._rejectUnauthorized=W,X.#X(this.localPort,N),V.maxConnections&&V[H]>=V.maxConnections){const Y={localAddress:X.localAddress,localPort:X.localPort,localFamily:X.localFamily,remoteAddress:X.remoteAddress,remotePort:X.remotePort,remoteFamily:X.remoteFamily||"IPv4"};N.end(),V.emit("drop",Y);return}if(!G)X.resume();if(V[H]++,typeof J=="function")if(K.name==="TLSSocket")V.once("secureConnection",()=>J(X));else J(X);V.emit("connection",X)},handshake({data:N},V,Z){if(N._securePending=!1,N.secureConnecting=!1,N._secureEstablished=!!V,N._requestCert||N._rejectUnauthorized){if(Z){if(N.authorized=!1,N.authorizationError=Z.code||Z.message,N._rejectUnauthorized){N.destroy(Z);return}}}else N.authorized=!0;N.emit("secureConnect",Z)},error(N,V){A.#A.error(N,V),this.data.emit("error",V)},timeout:A.#A.timeout,connectError:A.#A.connectError,drain:A.#A.drain,binaryType:"buffer"};bytesRead=0;bytesWritten=0;#Z=!1;connecting=!1;localAddress="127.0.0.1";#G=h();remotePort;#J;timeout=0;#K;#M;#W;isServer=!1;constructor(N){const{signal:V,write:Z,read:G,allowHalfOpen:J=!1,...K}=N||{};super({...K,allowHalfOpen:J,readable:!0,writable:!0});this.#W=void 0,V?.once("abort",()=>this.destroy()),this.once("connect",()=>this.emit("ready"))}address(){return{address:this.localAddress,family:this.localFamily,port:this.localPort}}get bufferSize(){return this.writableLength}#X(N,V){this.remotePort=N,V.data=this,V.timeout(this.timeout),V.ref(),this.#J=V,this.connecting=!1,this.emit("connect",this),A.#V(V)}connect(N,V,Z){var G;if(typeof N==="string"){if(G=N,N=void 0,typeof V==="function")Z=V,V=void 0}else if(typeof V=="function"){if(typeof N==="string")G=N,N=void 0;Z=V,V=void 0}if(typeof N=="object"){var{port:N,host:V,path:G,localAddress:J,localPort:K,family:M,hints:W,lookup:X,noDelay:Y,keepAlive:$,keepAliveInitialDelay:B,requestCert:F,rejectUnauthorized:Q,pauseOnConnect:R,servername:D}=N;this.servername=D}if(!R)this.resume();this.connecting=!0,this.remotePort=N;const z=this[S];var q=void 0;if(typeof z==="function"){if(q=z.call(this,N,V,!0),this._requestCert=!0,this._rejectUnauthorized=Q,q)if(typeof q!=="object")q={rejectUnauthorized:Q,requestCert:!0};else q.rejectUnauthorized=Q,q.requestCert=!0;if(this.authorized=!1,this.secureConnecting=!0,this._secureEstablished=!1,this._securePending=!0,Z)this.on("secureConnect",Z)}else if(Z)this.on("connect",Z);return v(G?{data:this,unix:G,socket:A.#A,tls:q}:{data:this,hostname:V||"localhost",port:N,socket:A.#A,tls:q}),this}_destroy(N,V){this.#J?.end(),V(N)}_final(N){this.#J?.end(),N()}get localAddress(){return"127.0.0.1"}get localFamily(){return"IPv4"}get localPort(){return this.#J?.localPort}get pending(){return this.connecting}_read(N){const V=this.#G;let Z;while(Z=V.peek()){if(!this.push(Z))return;V.shift()}}get readyState(){if(this.connecting)return"opening";if(this.readable)return this.writable?"open":"readOnly";else return this.writable?"writeOnly":"closed"}ref(){this.#J?.ref()}get remoteAddress(){return this.#J?.remoteAddress}get remoteFamily(){return"IPv4"}resetAndDestroy(){this.#J?.end()}setKeepAlive(N=!1,V=0){return this}setNoDelay(N=!0){return this}setTimeout(N,V){if(this.#J?.timeout(N),this.timeout=N,V)this.once("timeout",V);return this}unref(){this.#J?.unref()}_write(N,V,Z){if(typeof N=="string"&&V!=="utf8")N=Buffer.from(N,V);var G=this.#J?.write(N);if(G==N.length)Z();else if(this.#K)Z(new Error("overlapping _write()"));else{if(G>0)if(typeof N=="string")N=N.slice(G);else N=N.subarray(G);this.#K=Z,this.#M=N}}}),a=i;class k extends u{#A;#N=!1;[H]=0;[T];maxConnections=0;constructor(A,N){super();if(typeof A==="function")N=A,A={};else if(A==null||typeof A==="object")A={...A};else throw new Error("bun-net-polyfill: invalid arguments");const{maxConnections:V}=A;this.maxConnections=Number.isSafeInteger(V)&&V>0?V:0,A.connectionListener=N,this[T]=A}ref(){return this.#A?.ref(),this}unref(){return this.#A?.unref(),this}close(A){if(this.#A){if(this.#A.stop(!0),this.#A=null,this.#N=!1,this[H]=0,this.emit("close"),typeof A==="function")A();return this}if(typeof A==="function"){const N=new Error("Server is not running");N.code="ERR_SERVER_NOT_RUNNING",A(N)}return this}address(){const A=this.#A;if(A){const N=A.unix;if(N)return N;let V=A.hostname;const Z=L(V),G=A.port;if(typeof G==="number")return{port:G,address:V,family:Z?`IPv${Z}`:void 0};if(Z)return{address:V,family:Z?`IPv${Z}`:void 0};return V}return null}getConnections(A){if(typeof A==="function")A(null,this.#A?this[H]:0);return this}listen(A,N,V){let Z,G,J=!1;if(typeof A==="string"){if(Number.isSafeInteger(N)){if(N>0)Z=N}else if(typeof N==="function")V=N;G=A,N=void 0,A=void 0}else{if(typeof N==="function")V=N,N=void 0;if(typeof A==="function")V=A,A=0;else if(typeof A==="object"){const W=A;W.signal?.addEventListener("abort",()=>this.close()),N=W.host,J=W.exclusive===!0;const X=W.path;if(A=W.port,!Number.isSafeInteger(A)||A<0)if(X)N=X,A=void 0;else{let Y='The argument \'options\' must have the property "port" or "path"';try{Y=`${Y}. Received ${JSON.stringify(W)}`}catch{}const $=new TypeError(Y);throw $.code="ERR_INVALID_ARG_VALUE",$}else if(!Number.isSafeInteger(A)||A<0)A=0;if(typeof A.callback==="function")V=A?.callback}else if(!Number.isSafeInteger(A)||A<0)A=0;N=N||"::"}try{var K=void 0,M=void 0;const W=this[S];if(typeof W==="function")[K,M]=W.call(this,A,N,!1);this[T].InternalSocketClass=M||_,this.#A=b.listen(G?{exclusive:J,unix:G,tls:K,socket:_[y]}:{exclusive:J,port:A,hostname:N,tls:K,socket:_[y]}),this.#A.data=this,this.#N=!0,E(c,1,this,V)}catch(W){this.#N=!1,E(l,1,this,W)}return this}}var r={createServer:n,Server:k,createConnection:i,connect:a,isIP:L,isIPv4:C,isIPv6:m,Socket:p,[Symbol.for("CommonJS")]:0,[Symbol.for("::bunternal::")]:_};export{m as isIPv6,C as isIPv4,L as isIP,r as default,n as createServer,i as createConnection,a as connect,p as Socket,k as Server};
