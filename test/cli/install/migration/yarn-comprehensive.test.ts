import { describe, expect, test } from "bun:test";
import fs from "fs";
import { bunEnv, bunExe, tempDirWithFiles } from "harness";
import { join } from "path";

describe("Yarn v1 comprehensive migration - all quirks", () => {
  test("all yarn v1 quirks in one test", async () => {
    const tempDir = tempDirWithFiles("yarn-comprehensive", {
      "package.json": JSON.stringify(
        {
          name: "yarn-quirks-test",
          version: "1.0.0",
          private: true,
          workspaces: ["packages/*"],
          dependencies: {
            // Multi-spec consolidation: multiple ranges -> same version
            "is-number": "^7.0.0",
            // npm alias
            "my-lodash": "npm:lodash@4.17.21",
            // Scoped package
            "@babel/core": "^7.20.0",
            // Long build tag
            "@prisma/engines": "4.16.1-1.4bc8b6e1b66cb932731fb1bdbbc550d1e010de81",
          },
          devDependencies: {
            // Multiple versions of same package
            "lodash": "^3.10.0",
          },
          optionalDependencies: {
            // Platform-specific (but yarn doesn't store os/cpu)
            "fsevents": "^2.3.2",
          },
        },
        null,
        2,
      ),
      "packages/app/package.json": JSON.stringify(
        {
          name: "@workspace/app",
          version: "1.0.0",
          dependencies: {
            // Workspace dependency
            "@workspace/lib": "workspace:*",
            // Creates multi-spec entry with root
            "is-number": "~7.0.0",
            // Different version than root
            "lodash": "^4.17.0",
          },
        },
        null,
        2,
      ),
      "packages/lib/package.json": JSON.stringify(
        {
          name: "@workspace/lib",
          version: "1.0.0",
          dependencies: {
            // External dep
            "is-odd": "^3.0.0",
          },
        },
        null,
        2,
      ),
      "yarn.lock": `# THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
# yarn lockfile v1


"@babel/core@^7.20.0":
  version "7.20.12"
  resolved "https://registry.yarnpkg.com/@babel/core/-/core-7.20.12.tgz#7f12f7fe01cfcc5c4f37fa6e09a6e7ac0736b5e9"
  integrity sha512-XsMfHovsUYHFMdrIHkZphTN/2Hzzi78R08NuHfDBehym2VsPDL6Zn/JAD/JQdnRvbSsbQc4mVaU1m6JgtTEElg==
  dependencies:
    "@babel/types" "^7.20.7"

"@babel/types@^7.20.7":
  version "7.20.7"
  resolved "https://registry.yarnpkg.com/@babel/types/-/types-7.20.7.tgz#54ec75e252318423fc07fb644dc6a58a64c09b7f"
  integrity sha512-69OnhBxSSgK0OzTJai4kyPDiKTIe3j+ctaHdIGVbRahTLAT7L3R9oeXHC2aVSuGYt3cVnoAMDmOCgJ2yaiLMvg==

"@prisma/engines@4.16.1-1.4bc8b6e1b66cb932731fb1bdbbc550d1e010de81":
  version "4.16.1-1.4bc8b6e1b66cb932731fb1bdbbc550d1e010de81"
  resolved "https://registry.yarnpkg.com/@prisma/engines/-/engines-4.16.1-1.4bc8b6e1b66cb932731fb1bdbbc550d1e010de81.tgz#5512069ca14c44af7f38e7c39d9a169480e63a33"
  integrity sha512-q617EUWfRIDTriWADZ4YiWRZXCa/WuhNgLTVd+HqWLffjMSPzyM5uOWoauX91wvQClSKZU4pzI4JJLQ9Kl62Qg==

"@workspace/lib@workspace:*, @workspace/lib@workspace:packages/lib":
  version "0.0.0-use.local"
  resolved "file:packages/lib"
  dependencies:
    is-odd "^3.0.0"

fsevents@^2.3.2:
  version "2.3.2"
  resolved "https://registry.yarnpkg.com/fsevents/-/fsevents-2.3.2.tgz#8a526f78b8fdf4623b709e0b975c52c24c02fd1a"
  integrity sha512-xiqMQR4xAeHTuB9uWm+fFRcIOgKBMiOBP+eXiyT7jsgVCq1bkVygt00oASowB7EdtpOHaaPgKt812P9ab+DDKA==

"is-number@^6.0.0":
  version "6.0.0"
  resolved "https://registry.yarnpkg.com/is-number/-/is-number-6.0.0.tgz#e6d15ad31fc262887d1846d1c6c84c9b3b0b5982"
  integrity sha512-Wu1VHeILBK8KAWJUAiSZQX94GmOE45Rg6/538fKwiloUu21KncEkYGPqob2oSZ5mUT73vLGrHQjKw3KMPwfDzg==

"is-number@^7.0.0, is-number@~7.0.0":
  version "7.0.0"
  resolved "https://registry.yarnpkg.com/is-number/-/is-number-7.0.0.tgz#7535345b896734d5f80c4d06c50955527a14f12b"
  integrity sha512-41Cifkg6e8TylSpdtTpeLVMqvSBEVzTttHvERD741+pnZ8ANv0004MRL43QKPDlK9cGvNp6NZWZUBlbGXYxxng==

is-odd@^3.0.0:
  version "3.0.1"
  resolved "https://registry.yarnpkg.com/is-odd/-/is-odd-3.0.1.tgz#65101baf63c59f7b5c3a429d0a4e3d8ca7914559"
  integrity sha512-CQpnWPrDwmP1+SMHXZhtLtJv90yiyVfluGsX5iNCVkrhQtU3TQHsUWPG9wkdk9Lgd5yNpAg9jQEo90CBaXgWMA==
  dependencies:
    is-number "^6.0.0"

lodash@^3.10.0:
  version "3.10.1"
  resolved "https://registry.yarnpkg.com/lodash/-/lodash-3.10.1.tgz#5bf45e8e49ba4189e17d482789dfd15bd140b7b6"
  integrity sha512-9mDDwqVIma6OZX79ZlDACZl8sBm0TEnkf99zV3iMA4GzkSTbUYwRa7cmPR8CKkkl+OuU/fGTM48FNhQ5GnLsXw==

"lodash@^4.17.0, lodash@4.17.21":
  version "4.17.21"
  resolved "https://registry.yarnpkg.com/lodash/-/lodash-4.17.21.tgz#679591c564c3bffaae8454cf0b3df370c3d6911c"
  integrity sha512-v2kDEe57lecTulaDIuNTPy3Ry4gLGJ6Z1O3vE1krgXZNrsQ+LFTGHVxVjcXPs17LhbZVGedAJv8XZ1tvj5FvSg==

my-lodash@npm:lodash@4.17.21:
  version "4.17.21"
  resolved "https://registry.yarnpkg.com/lodash/-/lodash-4.17.21.tgz#679591c564c3bffaae8454cf0b3df370c3d6911c"
  integrity sha512-v2kDEe57lecTulaDIuNTPy3Ry4gLGJ6Z1O3vE1krgXZNrsQ+LFTGHVxVjcXPs17LhbZVGedAJv8XZ1tvj5FvSg==
`,
    });

    const migrateResult = Bun.spawn({
      cmd: [bunExe(), "pm", "migrate", "-f"],
      cwd: tempDir,
      env: bunEnv,
      stdout: "pipe",
      stderr: "pipe",
      stdin: "ignore",
    });

    const [stdout, stderr, exitCode] = await Promise.all([
      migrateResult.stdout.text(),
      migrateResult.stderr.text(),
      migrateResult.exited,
    ]);

    if (exitCode !== 0) {
      console.error("STDOUT:", stdout);
      console.error("STDERR:", stderr);
    }

    expect(exitCode).toBe(0);
    expect(fs.existsSync(join(tempDir, "bun.lock"))).toBe(true);

    const bunLockContent = fs.readFileSync(join(tempDir, "bun.lock"), "utf8");

    // CRITICAL CHECKS - these must all pass

    // 1. Multi-spec consolidation: both specs resolve to same package
    expect(bunLockContent).toContain("is-number@7.0.0");
    expect(bunLockContent).not.toContain("is-number@^7.0.0");
    expect(bunLockContent).not.toContain("is-number@~7.0.0");

    // 2. npm alias: should create entry for alias pointing to real package
    expect(bunLockContent).toContain("my-lodash");
    expect(bunLockContent).toContain("lodash@4.17.21");

    // 3. Multiple versions: both lodash 3 and 4 should exist
    expect(bunLockContent).toContain("lodash@3.10.1");
    expect(bunLockContent).toContain("lodash@4.17.21");

    // 4. Long build tag preserved
    expect(bunLockContent).toContain("4.16.1-1.4bc8b6e1b66cb932731fb1bdbbc550d1e010de81");

    // 5. Scoped packages
    expect(bunLockContent).toContain("@babel/core");
    expect(bunLockContent).toContain("@babel/types");

    // 6. Workspace dependencies
    expect(bunLockContent).toContain("@workspace/app");
    expect(bunLockContent).toContain("@workspace/lib");
    // Workspace entries should NOT have full dependency info, just path
    const workspaceSection = bunLockContent.match(/"workspaces":\s*{[\s\S]*?},\s*"packages":/);
    expect(workspaceSection).toBeTruthy();

    // 7. Integrity hashes preserved
    expect(bunLockContent).toMatch(/sha512-/);

    // 8. No corruption artifacts
    expect(bunLockContent).not.toContain("monoreporeact");
    expect(bunLockContent).not.toContain("ï¿½");
    expect(bunLockContent).not.toContain("\0");
    expect(bunLockContent).not.toContain("undefined");

    // TODO: Once implementation is complete, replace these checks with snapshot
    // expect(bunLockContent).toMatchSnapshot("yarn-comprehensive");
  });

  test("parser handles indentation correctly", async () => {
    // Test that the parser correctly handles the YAML-like indentation
    const tempDir = tempDirWithFiles("yarn-indentation", {
      "package.json": JSON.stringify(
        {
          name: "indent-test",
          version: "1.0.0",
          dependencies: {
            "test-pkg": "^1.0.0",
          },
        },
        null,
        2,
      ),
      "yarn.lock": `# yarn lockfile v1

test-pkg@^1.0.0:
  version "1.0.0"
  resolved "https://registry.yarnpkg.com/test-pkg/-/test-pkg-1.0.0.tgz#abc123"
  integrity sha512-test123==
  dependencies:
    dep-a "^1.0.0"
    dep-b "^2.0.0"

dep-a@^1.0.0:
  version "1.0.0"
  resolved "https://registry.yarnpkg.com/dep-a/-/dep-a-1.0.0.tgz#def456"
  integrity sha512-testa==

dep-b@^2.0.0:
  version "2.0.0"
  resolved "https://registry.yarnpkg.com/dep-b/-/dep-b-2.0.0.tgz#ghi789"
  integrity sha512-testb==
`,
    });

    const migrateResult = Bun.spawn({
      cmd: [bunExe(), "pm", "migrate", "-f"],
      cwd: tempDir,
      env: bunEnv,
      stdout: "pipe",
      stderr: "pipe",
      stdin: "ignore",
    });

    const [exitCode, stdout, stderr] = await Promise.all([
      migrateResult.exited,
      migrateResult.stdout.text(),
      migrateResult.stderr.text(),
    ]);
    console.log("STDOUT:", stdout);
    console.log("STDERR:", stderr);
    expect(exitCode).toBe(0);

    const bunLockContent = fs.readFileSync(join(tempDir, "bun.lock"), "utf8");
    expect(bunLockContent).toContain("test-pkg");
    expect(bunLockContent).toContain("dep-a");
    expect(bunLockContent).toContain("dep-b");
  });

  test("handles optionalDependencies correctly", async () => {
    const tempDir = tempDirWithFiles("yarn-optional", {
      "package.json": JSON.stringify(
        {
          name: "optional-test",
          version: "1.0.0",
          dependencies: {
            "pkg-a": "^1.0.0",
          },
        },
        null,
        2,
      ),
      "yarn.lock": `# yarn lockfile v1

pkg-a@^1.0.0:
  version "1.0.0"
  resolved "https://registry.yarnpkg.com/pkg-a/-/pkg-a-1.0.0.tgz#abc"
  integrity sha512-testoptional==
  optionalDependencies:
    optional-dep "^1.0.0"

optional-dep@^1.0.0:
  version "1.0.0"
  resolved "https://registry.yarnpkg.com/optional-dep/-/optional-dep-1.0.0.tgz#def"
  integrity sha512-testopt2==
`,
    });

    const migrateResult = Bun.spawn({
      cmd: [bunExe(), "pm", "migrate", "-f"],
      cwd: tempDir,
      env: bunEnv,
      stdout: "pipe",
      stderr: "pipe",
      stdin: "ignore",
    });

    const exitCode = await migrateResult.exited;
    expect(exitCode).toBe(0);

    const bunLockContent = fs.readFileSync(join(tempDir, "bun.lock"), "utf8");
    expect(bunLockContent).toContain("pkg-a");
    expect(bunLockContent).toContain("optional-dep");
    // Should have optionalDependencies field in metadata
    expect(bunLockContent).toMatch(/optionalDependencies/);
  });
});
