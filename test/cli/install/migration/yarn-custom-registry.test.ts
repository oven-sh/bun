import { describe, expect, test } from "bun:test";
import fs from "fs";
import { bunEnv, bunExe, tempDirWithFiles } from "harness";
import { join } from "path";

describe("yarn.lock custom registry migration", () => {
  test("custom registry tarball URLs", async () => {
    const tempDir = tempDirWithFiles("yarn-migration-custom-registry", {
      "package.json": JSON.stringify(
        {
          name: "custom-registry-test",
          version: "1.0.0",
          dependencies: {
            "my-package": "https://my-custom-registry.com/my-package/-/my-package-1.0.0.tgz",
            "another-pkg": "https://packages.example.com/tarballs/another-pkg-2.1.0.tgz",
          },
        },
        null,
        2,
      ),
      "yarn.lock": `# THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
# yarn lockfile v1


"another-pkg@https://packages.example.com/tarballs/another-pkg-2.1.0.tgz":
  version "2.1.0"
  resolved "https://packages.example.com/tarballs/another-pkg-2.1.0.tgz#abc123def456"
  integrity sha512-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=

"my-package@https://my-custom-registry.com/my-package/-/my-package-1.0.0.tgz":
  version "1.0.0"
  resolved "https://my-custom-registry.com/my-package/-/my-package-1.0.0.tgz#deadbeef"
  integrity sha512-BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB=
`,
    });

    const migrateResult = await Bun.spawn({
      cmd: [bunExe(), "pm", "migrate", "-f"],
      cwd: tempDir,
      env: bunEnv,
      stdout: "pipe",
      stderr: "pipe",
      stdin: "ignore",
    });

    const [stdout, stderr, exitCode] = await Promise.all([
      new Response(migrateResult.stdout).text(),
      new Response(migrateResult.stderr).text(),
      migrateResult.exited,
    ]);

    expect(exitCode).toBe(0);
    expect(fs.existsSync(join(tempDir, "bun.lock"))).toBe(true);

    const bunLockContent = fs.readFileSync(join(tempDir, "bun.lock"), "utf8");
    
    expect(bunLockContent).toContain("my-package");
    expect(bunLockContent).toContain("another-pkg");
    expect(bunLockContent).toContain("my-custom-registry.com");
    expect(bunLockContent).toContain("packages.example.com");
  });
});
