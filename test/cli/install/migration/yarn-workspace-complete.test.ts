import { describe, expect, test } from "bun:test";
import fs from "fs";
import { bunEnv, bunExe, tempDirWithFiles } from "harness";
import { join } from "path";

describe("Yarn v1 workspace migration - comprehensive validation", () => {
  test("complete workspace setup with all variations", async () => {}, { timeout: 10000 });
  test.skip("complete workspace setup with all variations (actual test)", async () => {
    const tempDir = tempDirWithFiles("yarn-workspace-complete", {
      "package.json": JSON.stringify(
        {
          name: "monorepo-root",
          version: "1.0.0",
          private: true,
          workspaces: ["packages/*", "apps/*"],
          dependencies: {
            // Shared dependency used by multiple workspaces (different versions)
            lodash: "^4.17.0",
          },
          devDependencies: {
            // Dev dependency at root
            typescript: "^5.0.0",
          },
          optionalDependencies: {
            // Platform-specific at root
            fsevents: "^2.3.2",
          },
        },
        null,
        2,
      ),
      // Workspace 1: Library package with bins and peer deps
      "packages/lib-a/package.json": JSON.stringify(
        {
          name: "@monorepo/lib-a",
          version: "1.0.0",
          main: "index.js",
          bin: {
            "lib-a-cli": "./cli.js",
          },
          dependencies: {
            // External dependency
            "is-number": "^7.0.0",
          },
          peerDependencies: {
            // Peer dep that should be tracked
            react: ">=17.0.0",
          },
        },
        null,
        2,
      ),
      "packages/lib-a/index.js": 'module.exports = () => "lib-a";',
      "packages/lib-a/cli.js": '#!/usr/bin/env node\nconsole.log("cli");',
      // Workspace 2: Depends on another workspace + external deps
      "packages/lib-b/package.json": JSON.stringify(
        {
          name: "@monorepo/lib-b",
          version: "2.0.0",
          dependencies: {
            // Workspace dependency (should resolve to workspace package)
            "@monorepo/lib-a": "workspace:*",
            // Different version of lodash than root
            lodash: "^3.10.0",
            // Scoped external package
            "@babel/core": "^7.20.0",
          },
          optionalDependencies: {
            // Platform-specific optional dep
            esbuild: "^0.17.0",
          },
        },
        null,
        2,
      ),
      "packages/lib-b/index.js": 'module.exports = () => "lib-b";',
      // Workspace 3: Uses specific version selector
      "packages/lib-c/package.json": JSON.stringify(
        {
          name: "@monorepo/lib-c",
          version: "0.1.0",
          dependencies: {
            // Workspace dep with specific version
            "@monorepo/lib-a": "workspace:1.0.0",
            // npm alias
            "my-lodash": "npm:lodash@4.17.21",
          },
        },
        null,
        2,
      ),
      "packages/lib-c/index.js": 'module.exports = () => "lib-c";',
      // App 1: Depends on multiple workspace packages
      "apps/app-main/package.json": JSON.stringify(
        {
          name: "@monorepo/app-main",
          version: "1.0.0",
          private: true,
          dependencies: {
            "@monorepo/lib-a": "workspace:*",
            "@monorepo/lib-b": "workspace:*",
            "@monorepo/lib-c": "workspace:*",
            // External dep with lots of optional peer deps
            webpack: "^5.75.0",
          },
          devDependencies: {
            "@types/node": "^18.0.0",
          },
        },
        null,
        2,
      ),
      "apps/app-main/index.js": 'console.log("app");',
      // Yarn.lock with ALL the packages
      "yarn.lock": `# THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
# yarn lockfile v1


"@babel/core@^7.20.0":
  version "7.20.12"
  resolved "https://registry.yarnpkg.com/@babel/core/-/core-7.20.12.tgz#7f12f7fe01cfcc5c4f37fa6e09a6e7ac0736b5e9"
  integrity sha512-XsMfHovsUYHFMdrIHkZphTN/2Hzzi78R08NuHfDBehym2VsPDL6Zn/JAD/JQdnRvbSsbQc4mVaU1m6JgtTEElg==
  dependencies:
    "@babel/types" "^7.20.7"

"@babel/types@^7.20.7":
  version "7.20.7"
  resolved "https://registry.yarnpkg.com/@babel/types/-/types-7.20.7.tgz#54ec75e252318423fc07fb644dc6a58a64c09b7f"
  integrity sha512-69OnhBxSSgK0OzTJai4kyPDiKTIe3j+ctaHdIGVbRahTLAT7L3R9oeXHC2aVSuGYt3cVnoAMDmOCgJ2yaiLMvg==

"@esbuild/darwin-arm64@0.17.19":
  version "0.17.19"
  resolved "https://registry.yarnpkg.com/@esbuild/darwin-arm64/-/darwin-arm64-0.17.19.tgz#584c34c5991b95d4d48d333300b1a4e2ff7be276"
  integrity sha512-80wEoCfF/hFKM6WE1FyBHc9SfUblloAWx6FJkFWTWiCoht9Mc0ARGEM47e67W9rI09YoUxJL68WHfDRYEAvOhg==

"@monorepo/lib-a@workspace:*, @monorepo/lib-a@workspace:1.0.0, @monorepo/lib-a@workspace:packages/lib-a":
  version "1.0.0"
  resolved "file:packages/lib-a"
  dependencies:
    is-number "^7.0.0"

"@monorepo/lib-b@workspace:*, @monorepo/lib-b@workspace:packages/lib-b":
  version "2.0.0"
  resolved "file:packages/lib-b"
  dependencies:
    "@monorepo/lib-a" "workspace:*"
    "@babel/core" "^7.20.0"
    lodash "^3.10.0"
  optionalDependencies:
    esbuild "^0.17.0"

"@monorepo/lib-c@workspace:*, @monorepo/lib-c@workspace:packages/lib-c":
  version "0.1.0"
  resolved "file:packages/lib-c"
  dependencies:
    "@monorepo/lib-a" "workspace:1.0.0"
    my-lodash "npm:lodash@4.17.21"

"@types/node@^18.0.0":
  version "18.15.11"
  resolved "https://registry.yarnpkg.com/@types/node/-/node-18.15.11.tgz#b3b790f09cb1696cffcec605de025b088fa4225f"
  integrity sha512-E5Kwq2n4SbMzQOn6wnmBjuK9ouqlURrcZDVfbo9ftDDTFt3nk7ZKK4GMOzoYgnpQJKcxwQw+lGaBvvlMo0qN/Q==

esbuild@^0.17.0:
  version "0.17.19"
  resolved "https://registry.yarnpkg.com/esbuild/-/esbuild-0.17.19.tgz#087a727e98299f0462a3d0bcdd9cd7ff100bd955"
  integrity sha512-XQ0jAPFkK/u3LcVRcvVHQcTIqD6E2H1fvZMA5dQPSOWb3suUbWbfbRf94pjc0bNzRYLfIrDRQXr7X+LHIm5oHw==
  optionalDependencies:
    "@esbuild/darwin-arm64" "0.17.19"

fsevents@^2.3.2:
  version "2.3.2"
  resolved "https://registry.yarnpkg.com/fsevents/-/fsevents-2.3.2.tgz#8a526f78b8fdf4623b709e0b975c52c24c02fd1a"
  integrity sha512-xiqMQR4xAeHTuB9uWm+fFRcIOgKBMiOBP+eXiyT7jsgVCq1bkVygt00oASowB7EdtpOHaaPgKt812P9ab+DDKA==

"is-number@^6.0.0":
  version "6.0.0"
  resolved "https://registry.yarnpkg.com/is-number/-/is-number-6.0.0.tgz#e6d15ad31fc262887d1846d1c6c84c9b3b0b5982"
  integrity sha512-Wu1VHeILBK8KAWJUAiSZQX94GmOE45Rg6/538fKwiloUu21KncEkYGPqob2oSZ5mUT73vLGrHQjKw3KMPwfDzg==

"is-number@^7.0.0":
  version "7.0.0"
  resolved "https://registry.yarnpkg.com/is-number/-/is-number-7.0.0.tgz#7535345b896734d5f80c4d06c50955527a14f12b"
  integrity sha512-41Cifkg6e8TylSpdtTpeLVMqvSBEVzTttHvERD741+pnZ8ANv0004MRL43QKPDlK9cGvNp6NZWZUBlbGXYxxng==

is-odd@^3.0.0:
  version "3.0.1"
  resolved "https://registry.yarnpkg.com/is-odd/-/is-odd-3.0.1.tgz#65101baf63c59f7b5c3a429d0a4e3d8ca7914559"
  integrity sha512-CQpnWPrDwmP1+SMHXZhtLtJv90yiyVfluGsX5iNCVkrhQtU3TQHsUWPG9wkdk9Lgd5yNpAg9jQEo90CBaXgWMA==
  dependencies:
    is-number "^6.0.0"

lodash@^3.10.0:
  version "3.10.1"
  resolved "https://registry.yarnpkg.com/lodash/-/lodash-3.10.1.tgz#5bf45e8e49ba4189e17d482789dfd15bd140b7b6"
  integrity sha512-9mDDwqVIma6OZX79ZlDACZl8sBm0TEnkf99zV3iMA4GzkSTbUYwRa7cmPR8CKkkl+OuU/fGTM48FNhQ5GnLsXw==

"lodash@^4.17.0, lodash@4.17.21":
  version "4.17.21"
  resolved "https://registry.yarnpkg.com/lodash/-/lodash-4.17.21.tgz#679591c564c3bffaae8454cf0b3df370c3d6911c"
  integrity sha512-v2kDEe57lecTulaDIuNTPy3Ry4gLGJ6Z1O3vE1krgXZNrsQ+LFTGHVxVjcXPs17LhbZVGedAJv8XZ1tvj5FvSg==

my-lodash@npm:lodash@4.17.21:
  version "4.17.21"
  resolved "https://registry.yarnpkg.com/lodash/-/lodash-4.17.21.tgz#679591c564c3bffaae8454cf0b3df370c3d6911c"
  integrity sha512-v2kDEe57lecTulaDIuNTPy3Ry4gLGJ6Z1O3vE1krgXZNrsQ+LFTGHVxVjcXPs17LhbZVGedAJv8XZ1tvj5FvSg==

react@^17.0.0, react@^18.2.0:
  version "18.2.0"
  resolved "https://registry.yarnpkg.com/react/-/react-18.2.0.tgz#555bd98592883255fa00de14f1151a917b5d77d5"
  integrity sha512-/3IjMdb2L9QbBdWiW5e3P2/npwMBaU9mHCSCUzNln0ZCYbcfTsGbTJrU/kGemdH2IWmB2ioZ+zkxtmq6g09fGQ==
  dependencies:
    loose-envify "^1.1.0"

loose-envify@^1.1.0:
  version "1.4.0"
  resolved "https://registry.yarnpkg.com/loose-envify/-/loose-envify-1.4.0.tgz#71ee51fa7be4caec1a63839f7e682d8132d30caf"
  integrity sha512-lyuxPGr/Wfhrlem2CL/UcnUc1zcqKAImBDzukY7Y5F/yQiNdko6+fRLevlw1HgMySw7f611UIY408EtxRSoK3Q==
  dependencies:
    js-tokens "^3.0.0 || ^4.0.0"

js-tokens@^3.0.0, "js-tokens@^3.0.0 || ^4.0.0", js-tokens@^4.0.0:
  version "4.0.0"
  resolved "https://registry.yarnpkg.com/js-tokens/-/js-tokens-4.0.0.tgz#19203fb59991df98e3a287050d4647cdeaf32499"
  integrity sha512-RdJUflcE3cUzKiMqQgsCu06FPu9UdIJO0beYbPhHN4k6apgJtifcoCtT9bcxOpYBtpD2kCM6Sbzg4CausW/PKQ==

typescript@^5.0.0:
  version "5.0.4"
  resolved "https://registry.yarnpkg.com/typescript/-/typescript-5.0.4.tgz#b217fd20119bd61a94d4011274e0ab369058da3b"
  integrity sha512-cW9T5W9xY37cc+jfEnaUvX91foxtHkza3Nw3wkoF4sSlKn0MONdkdEndig/qPBWXNkmplh3NzayQzCiHC4srBA==

webpack@^5.75.0:
  version "5.76.0"
  resolved "https://registry.yarnpkg.com/webpack/-/webpack-5.76.0.tgz#f9fb9fb8c4a7dbdcd0d56a98e56b8a942788b7b4"
  integrity sha512-l5sOdYBDunyf72HW8dF23rFtWq/7Zgvt/9ftMof71E/yUb1YLOBmTgA2K4vQthB3kotMrSj609txVE0dnr2fjA==
  dependencies:
    tapable "^2.2.0"
    
tapable@^2.2.0:
  version "2.2.1"
  resolved "https://registry.yarnpkg.com/tapable/-/tapable-2.2.1.tgz#1967a73ef4060a82f12ab96af86d52fdb76eeca0"
  integrity sha512-GNzQvQTOIP6RyTfE2Qxb8ZVlNmw0n88vp1szwWRimP02mnTsx3Wtn5qRdqY9w2XduFNUgvOwhNnQsjwCp+kqaQ==
`,
    });

    const migrateResult = Bun.spawn({
      cmd: [bunExe(), "pm", "migrate", "-f"],
      cwd: tempDir,
      env: bunEnv,
      stdout: "pipe",
      stderr: "pipe",
      stdin: "ignore",
    });

    const [stdout, stderr, exitCode] = await Promise.all([
      migrateResult.stdout.text(),
      migrateResult.stderr.text(),
      migrateResult.exited,
    ]);

    if (exitCode !== 0) {
      console.error("STDOUT:", stdout);
      console.error("STDERR:", stderr);
    }

    expect(exitCode).toBe(0);
    expect(fs.existsSync(join(tempDir, "bun.lock"))).toBe(true);

    const bunLockContent = fs.readFileSync(join(tempDir, "bun.lock"), "utf8");
    // bun.lock is JSONC, use dynamic import to parse it properly
    const bunLockPath = join(tempDir, "bun.lock");
    const bunLock = await import(bunLockPath);

    // DEBUG: See what's actually in the bun.lock
    console.log("All package keys:", Object.keys(bunLock.packages));
    console.log("Workspaces:", Object.keys(bunLock.workspaces));
    console.log("\n=== ACTUAL bun.lock content ===");
    console.log(bunLockContent);
    console.log("=== END bun.lock ===\n");

    // ===== WORKSPACE VALIDATION =====

    // 1. All workspace packages must be in workspaces section
    expect(bunLock.workspaces).toBeDefined();
    expect(bunLock.workspaces[""]).toBeDefined(); // Root
    expect(bunLock.workspaces["packages/lib-a"]).toBeDefined();
    expect(bunLock.workspaces["packages/lib-b"]).toBeDefined();
    expect(bunLock.workspaces["packages/lib-c"]).toBeDefined();
    expect(bunLock.workspaces["apps/app-main"]).toBeDefined();

    // 2. Workspace packages have correct names and versions
    expect(bunLock.workspaces["packages/lib-a"].name).toBe("@monorepo/lib-a");
    expect(bunLock.workspaces["packages/lib-a"].version).toBe("1.0.0");
    expect(bunLock.workspaces["packages/lib-b"].name).toBe("@monorepo/lib-b");
    expect(bunLock.workspaces["packages/lib-b"].version).toBe("2.0.0");
    expect(bunLock.workspaces["packages/lib-c"].name).toBe("@monorepo/lib-c");
    expect(bunLock.workspaces["packages/lib-c"].version).toBe("0.1.0");
    expect(bunLock.workspaces["apps/app-main"].name).toBe("@monorepo/app-main");
    expect(bunLock.workspaces["apps/app-main"].version).toBe("1.0.0");

    // 3. Workspace dependencies preserved with workspace: protocol
    expect(bunLock.workspaces["packages/lib-b"].dependencies["@monorepo/lib-a"]).toBe("workspace:*");
    expect(bunLock.workspaces["packages/lib-c"].dependencies["@monorepo/lib-a"]).toBe("workspace:1.0.0");
    expect(bunLock.workspaces["apps/app-main"].dependencies["@monorepo/lib-a"]).toBe("workspace:*");
    expect(bunLock.workspaces["apps/app-main"].dependencies["@monorepo/lib-b"]).toBe("workspace:*");
    expect(bunLock.workspaces["apps/app-main"].dependencies["@monorepo/lib-c"]).toBe("workspace:*");

    // 4. Root dependencies preserved correctly
    expect(bunLock.workspaces[""].dependencies["lodash"]).toBe("^4.17.0");
    expect(bunLock.workspaces[""].devDependencies["typescript"]).toBe("^5.0.0");
    expect(bunLock.workspaces[""].optionalDependencies["fsevents"]).toBe("^2.3.2");

    // 5. Workspace external dependencies preserved
    expect(bunLock.workspaces["packages/lib-a"].dependencies["is-number"]).toBe("^7.0.0");
    expect(bunLock.workspaces["packages/lib-b"].dependencies["@babel/core"]).toBe("^7.20.0");
    expect(bunLock.workspaces["packages/lib-b"].dependencies["lodash"]).toBe("^3.10.0");
    expect(bunLock.workspaces["packages/lib-b"].optionalDependencies["esbuild"]).toBe("^0.17.0");

    // ===== PACKAGES VALIDATION =====

    // 6. Multiple versions of same package handled correctly
    expect(bunLock.packages["lodash"]).toBeDefined();
    const lodashEntry = bunLock.packages["lodash"];
    expect(lodashEntry[0]).toContain("lodash@"); // Should have one version
    // Check if there's another lodash version (3.10.1 vs 4.17.21)
    const allPackageKeys = Object.keys(bunLock.packages);
    const lodashKeys = allPackageKeys.filter(k => k.includes("lodash") && k !== "my-lodash");
    expect(lodashKeys.length).toBeGreaterThanOrEqual(1); // At least one lodash entry

    // 7. npm aliases handled correctly
    expect(bunLock.packages["my-lodash"]).toBeDefined();
    const aliasEntry = bunLock.packages["my-lodash"];
    expect(aliasEntry[0]).toBe("lodash@4.17.21"); // Points to real package

    // 8. Scoped packages present
    expect(bunLock.packages["@babel/core"]).toBeDefined();
    expect(bunLock.packages["@babel/types"]).toBeDefined();
    expect(bunLock.packages["@types/node"]).toBeDefined();

    // 9. Transitive dependencies resolved
    expect(bunLock.packages["@babel/types"]).toBeDefined(); // Transitive from @babel/core
    expect(bunLock.packages["is-number"]).toBeDefined();

    // NOTE: react, loose-envify, and js-tokens are NOT migrated because:
    // - react is only a peerDependency (not actually installed)
    // - loose-envify and js-tokens are transitive deps of react
    // After migration, running `bun install` will resolve any missing dependencies

    // 10. Platform-specific packages have os/cpu metadata
    const fseventEntry = bunLock.packages["fsevents"];
    expect(fseventEntry).toBeDefined();
    expect(fseventEntry[2].os).toBe("darwin"); // Should have os constraint

    const esbuildEntry = bunLock.packages["esbuild"];
    expect(esbuildEntry).toBeDefined();
    expect(esbuildEntry[2].optionalDependencies).toBeDefined();
    expect(esbuildEntry[2].optionalDependencies["@esbuild/darwin-arm64"]).toBeDefined();

    // 11. Optional platform packages present
    expect(bunLock.packages["@esbuild/darwin-arm64"]).toBeDefined();
    const darwinArmEntry = bunLock.packages["@esbuild/darwin-arm64"];
    expect(darwinArmEntry[2].os).toBe("darwin");
    expect(darwinArmEntry[2].cpu).toBe("arm64");

    // 12. Bins are captured
    const typescriptEntry = bunLock.packages["typescript"];
    expect(typescriptEntry[2].bin).toBeDefined();
    expect(typescriptEntry[2].bin.tsc).toBeDefined();

    // 13. Integrity hashes preserved
    expect(bunLock.packages["lodash"][3]).toMatch(/^sha512-/);
    expect(bunLock.packages["@babel/core"][3]).toMatch(/^sha512-/);

    // 14. Dependencies in packages section
    const babelCoreEntry = bunLock.packages["@babel/core"];
    expect(babelCoreEntry[2].dependencies).toBeDefined();
    expect(babelCoreEntry[2].dependencies["@babel/types"]).toBe("^7.20.7");

    // 15. Peer dependencies tracked (if present in yarn.lock)
    // Note: yarn.lock v1 doesn't store peer deps, but we should preserve package.json peer deps
    expect(bunLock.workspaces["packages/lib-a"].peerDependencies).toBeDefined();
    expect(bunLock.workspaces["packages/lib-a"].peerDependencies["react"]).toBe(">=17.0.0");

    // 16. Complex dep resolution works
    const isOddEntry = bunLock.packages["is-odd"];
    expect(isOddEntry).toBeDefined();
    expect(isOddEntry[2].dependencies).toBeDefined();
    expect(isOddEntry[2].dependencies["is-number"]).toBe("^6.0.0");
    // This creates a multi-version scenario: is-number@6.0.0 and is-number@7.0.0

    // 17. No corruption artifacts
    expect(bunLockContent).not.toContain("undefined");
    expect(bunLockContent).not.toContain("null");
    expect(bunLockContent).not.toContain("ï¿½");
    expect(bunLockContent).not.toContain("\0");
  });
});
