// Test for https://github.com/oven-sh/bun/issues/25169
// Unicode characters in string literals should be preserved in Function.toString()
// instead of being escaped to \uXXXX sequences.

import { expect, test } from "bun:test";

test("Function.toString() preserves unicode in string literals", () => {
  // Simple string literal with emoji
  function withEmoji() {
    return "â€¼ï¸";
  }

  const source = withEmoji.toString();
  expect(source).toContain('"â€¼ï¸"');
  expect(source).not.toContain("\\u203C");
  expect(source).not.toContain("\\uFE0F");
});

test("Function.toString() preserves unicode in template literals", () => {
  // Template literal with unicode
  function withTemplate() {
    return `Hello â€¼ï¸ World`;
  }

  const source = withTemplate.toString();
  expect(source).toContain("â€¼ï¸");
  expect(source).not.toContain("\\u203C");
});

test("Function.toString() preserves unicode in String.raw template", () => {
  // This is the actual use case from unplugin-vue-router
  function getExportedTypeDeclarationsForRouteMap() {
    return String.raw`// Generated by test. ${"â€¼ï¸"} DO NOT MODIFY`;
  }

  const source = getExportedTypeDeclarationsForRouteMap.toString();
  // The interpolated string should preserve the emoji
  expect(source).toContain('"â€¼ï¸"');
  expect(source).not.toContain("\\u203C");
});

test("Unicode string values are correct at runtime", () => {
  const emoji = "â€¼ï¸";
  expect(emoji).toBe("â€¼ï¸");
  expect(emoji.length).toBe(2); // â€¼ï¸ is two code points: U+203C and U+FE0F

  // Check the actual codepoints
  expect(emoji.codePointAt(0)).toBe(0x203c);
  expect(emoji.codePointAt(1)).toBe(0xfe0f);
});

test("BMP unicode characters are preserved in strings", () => {
  // Test BMP (Basic Multilingual Plane) characters - codepoints <= 0xFFFF
  // These should be preserved in Function.toString()
  function bmpUnicode() {
    return "æ—¥æœ¬èªž ä¸­æ–‡ í•œêµ­ì–´";
  }

  const source = bmpUnicode.toString();
  expect(source).toContain("æ—¥æœ¬èªž");
  expect(source).toContain("ä¸­æ–‡");
  expect(source).toContain("í•œêµ­ì–´");
});

test("Supplementary characters (> U+FFFF) are escaped as surrogate pairs", () => {
  // Supplementary characters like emoji ðŸŽ‰ (U+1F389) require surrogate pairs in UTF-16
  // These are currently escaped to \uXXXX format due to how JSC stores strings
  // This is a known limitation that may be addressed in the future
  function supplementaryChar() {
    return "ðŸŽ‰";
  }

  const source = supplementaryChar.toString();
  // The emoji value should still work correctly at runtime
  expect(supplementaryChar()).toBe("ðŸŽ‰");
  // But in the source representation, it's escaped as surrogate pair
  expect(source).toContain("\\uD83C\\uDF89");
});
