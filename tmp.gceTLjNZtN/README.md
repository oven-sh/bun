# Yarn v1 Lockfile Format Research

This directory contains a comprehensive analysis of Yarn v1's `yarn.lock` format based on a real monorepo test case.

## Files

1. **yarn.lock** (3,730 lines)
   - The actual lockfile generated by Yarn v1.22.22
   - Contains ~315 packages with various dependency patterns

2. **YARN_LOCKFILE_ANALYSIS.md**
   - Complete format specification
   - Field documentation
   - Workspace handling
   - Comparison with Bun's needs

3. **YARN_LOCKFILE_EXAMPLES.md**
   - 14 real examples from the lockfile
   - Covers all major patterns and edge cases
   - Annotated with explanations

4. **PARSING_STRATEGY.md**
   - Step-by-step parsing algorithm
   - Pseudocode implementation
   - Testing strategy
   - Integration points for Bun

## Test Monorepo Structure

```
packages/
  ├── app/
  │   └── package.json (depends on lib-a, lib-b, react, lodash@4)
  ├── lib-a/
  │   └── package.json (depends on axios, lodash@4, peer: react)
  └── lib-b/
      └── package.json (depends on express, lodash@3, chalk)
```

## Key Findings

### Format Characteristics

- **YAML-like** but not standard YAML
- **Flat structure**: All packages at top level
- **Deduplication**: Multiple version ranges → single resolution
- **Indentation-based**: 0/2/4 spaces indicate hierarchy
- **No workspace metadata**: Workspace packages invisible in lockfile

### Critical Differences from Other Lockfiles

1. **No workspace entries**: Workspaces use symlinks, not in lockfile
2. **No dev/prod distinction**: All dependencies treated equally
3. **No peer dep metadata**: Only resolved dependencies
4. **Aggressive deduplication**: Many ranges → one version
5. **Simple format**: Just version, URL, integrity, dependencies

### What Bun Needs to Handle

- ✅ Parse quasi-YAML format
- ✅ Handle scoped packages (`@scope/name`)
- ✅ Support multi-version scenarios (lodash 3 vs 4)
- ✅ Reconstruct dependency graph from flat list
- ✅ Create workspace symlinks (not in lockfile)
- ✅ Implement compatible deduplication
- ✅ Support OR dependencies (`^3.0.0 || ^4.0.0`)

## Quick Stats

- **Lockfile size**: ~150KB
- **Total packages**: ~315
- **Duplicate versions**: 2 (lodash 3.10.1 and 4.17.21)
- **Max deduplication**: 7 ranges → 1 version (@babel/parser)
- **Workspace packages**: 3 (not in lockfile)

## Usage

```bash
# Generate this lockfile
yarn install

# View structure
cat yarn.lock | head -100

# Check for specific package
grep -A8 "^lodash@" yarn.lock

# Count total entries
grep -c "^  version" yarn.lock
```

## Next Steps for Bun

1. Implement parser following PARSING_STRATEGY.md
2. Add test cases from YARN_LOCKFILE_EXAMPLES.md
3. Integrate with existing install code
4. Test with real monorepos
5. Handle edge cases (git deps, file deps, etc.)
