# Yarn v1 Lockfile Format Analysis

## Overview

This document provides a comprehensive analysis of Yarn v1's yarn.lock format based on a real monorepo test case with:

- 3 workspace packages (app, lib-a, lib-b)
- Shared dependencies across workspaces
- Different versions of the same package (lodash v3 and v4)
- Transitive dependencies
- Peer dependencies (react in lib-a)
- Dev dependencies

## Lockfile Header

```yaml
# THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
# yarn lockfile v1
```

- **Line 1**: Warning comment about auto-generation
- **Line 2**: Format version identifier
- **Line 3**: Empty line separator

## Entry Format

### Basic Entry Structure

```yaml
package-name@version-range:
  version "resolved-version"
  resolved "registry-url"
  integrity "sri-hash"
  dependencies:
    dep1 "version-range"
    dep2 "version-range"
```

### Fields Present

1. **Key (Package Descriptor)**: `package-name@version-range`
   - Can have multiple version ranges separated by commas and spaces
   - Quoted strings
   - Examples:
     - `"lodash@^4.17.21":`
     - `"@babel/parser@^7.1.0", "@babel/parser@^7.14.7", "@babel/parser@^7.20.7":`

2. **version**: The exact resolved version (quoted string)
   - Example: `version "4.17.21"`

3. **resolved**: Full registry URL to the tarball (quoted string)
   - Example: `resolved "https://registry.yarnpkg.com/lodash/-/lodash-4.17.21.tgz#679591c564c3bffaae8454cf0b3df370c3d6911c"`
   - Format: `registry-url/package-name/-/package-name-version.tgz#shasum`

4. **integrity**: Subresource Integrity (SRI) hash (quoted string)
   - Example: `integrity sha512-v2kDEe57lecTulaDIuNTPy3Ry4gLGJ6Z1O3vE1krgXZNrsQ+LFTGHVxVjcXPs17LhbZVGedAJv8XZ1tvj5FvSg==`
   - Format: `sha512-base64hash==`

5. **dependencies**: Object mapping dependency names to version ranges
   - Only present if package has dependencies
   - Indented with 2 spaces
   - Each dependency on its own line with 4 spaces indent
   - Values are quoted version ranges

6. **optionalDependencies**: Same format as dependencies
   - Only present if package has optional dependencies

7. **peerDependencies**: NOT stored in lockfile
   - Peer deps metadata is not preserved in yarn.lock

## Multiple Version Resolution

When multiple version ranges resolve to the same version, they're combined in the key:

```yaml
"@babel/code-frame@^7.0.0", "@babel/code-frame@^7.12.13", "@babel/code-frame@^7.27.1":
  version "7.27.1"
  resolved "https://registry.yarnpkg.com/@babel/code-frame/-/code-frame-7.27.1.tgz"
  integrity sha512-cjQ7ZlQ0Mv3b47hABuTevyTuYN4i+loJKGeV9flcCgIK37cCXRh+L1bd3iBHlynerhQ7BhCkn2BPbQUL+rGqFg==
  dependencies:
    "@babel/helper-validator-identifier" "^7.27.1"
    js-tokens "^4.0.0"
    picocolors "^1.1.1"
```

This is Yarn's deduplication - multiple semver ranges that can be satisfied by the same version are merged.

## Multiple Versions of Same Package

When different version ranges cannot be satisfied by the same version, there are separate entries:

```yaml
lodash@^3.10.1: version "3.10.1"
  resolved "https://registry.yarnpkg.com/lodash/-/lodash-3.10.1.tgz"
  integrity sha512-9mDDwqVIma6OZX79ZlDACZl8sBm0TEnkf99zV3iMA4GzkIT/9hiqP5mY0HoT1iNLCrKc/R1HByV+yJfRWVJryQ==

lodash@^4.17.21: version "4.17.21"
  resolved "https://registry.yarnpkg.com/lodash/-/lodash-4.17.21.tgz"
  integrity sha512-v2kDEe57lecTulaDIuNTPy3Ry4gLGJ6Z1O3vE1krgXZNrsQ+LFTGHVxVjcXPs17LhbZVGedAJv8XZ1tvj5FvSg==
```

In our test case:

- `lib-b` depends on `lodash@^3.10.1` → resolves to `3.10.1`
- `lib-a` and `app` depend on `lodash@^4.17.21` → resolves to `4.17.21`
- Both versions are installed in node_modules (hoisted or nested)

## Workspace Dependencies

**Critical Finding**: Workspace packages do NOT appear in yarn.lock at all.

In our test monorepo:

- `app` depends on `lib-a@^1.0.0` and `lib-b@^1.0.0`
- These dependencies are NOT in yarn.lock
- Yarn creates symlinks in node_modules:
  ```
  node_modules/lib-a -> ../packages/lib-a
  node_modules/lib-b -> ../packages/lib-b
  ```

This is a key difference from npm/pnpm where workspace protocol might appear in lockfile.

## Dev Dependencies

Dev dependencies appear identically to regular dependencies in yarn.lock. There is NO distinction between:

- `dependencies`
- `devDependencies`
- `optionalDependencies` (except optionalDependencies field in entry)

The dependency graph is flattened, and only the resolved version matters.

## Transitive Dependencies

All transitive dependencies are listed individually as top-level entries. For example:

```yaml
# Direct dependency
"axios@^1.4.0":
  version "1.12.2"
  dependencies:
    follow-redirects "^1.15.6"
    form-data "^4.0.4"
    proxy-from-env "^1.1.0"

# Transitive dependencies also have top-level entries
"follow-redirects@^1.15.6":
  version "1.15.11"
  ...

"form-data@^4.0.4":
  version "4.0.4"
  dependencies:
    asynckit "^0.4.0"
    combined-stream "^1.0.8"
  ...
```

The entire dependency tree is flattened into a single level.

## Scoped Packages

Scoped packages (e.g., `@babel/core`) follow the same format:

```yaml
"@babel/core@^7.11.6", "@babel/core@^7.12.3", "@babel/core@^7.23.9":
  version "7.28.4"
  resolved "https://registry.yarnpkg.com/@babel/core/-/core-7.28.4.tgz"
  integrity sha512-2BCOP7TN8M+...
  dependencies:
    "@babel/code-frame" "^7.27.1"
    "@babel/generator" "^7.28.3"
    ...
```

## Indentation and Formatting

- **Keys**: No indentation, end with `:`
- **Fields**: Indented with 2 spaces
- **Dependency values**: Indented with 4 spaces (2 for field + 2 for object)
- **Quotes**: All package names, versions, URLs, and hashes are double-quoted
- **Separators**: Fields separated by newlines
- **Entry Separator**: Single blank line between entries

## Special Cases

### Packages with OR conditions in dependencies

```yaml
loose-envify@^1.1.0:
  version "1.4.0"
  dependencies:
    js-tokens "^3.0.0 || ^4.0.0"
```

The dependency value can contain OR conditions with `||`.

### Packages with no dependencies

```yaml
wrappy@1: version "1.0.2"
  resolved "https://registry.yarnpkg.com/wrappy/-/wrappy-1.0.2.tgz"
  integrity sha512-l4Sp/DRseor9wL6EvV2+TuQn63dMkPjZ/sp9XkghTEbV9KlPS1xUsZ3u7/IQO4wxtcFB4bgpQPRcR3QCvezPcQ==
```

No `dependencies` field if package has no dependencies.

## What's Missing (Compared to Bun's Needs)

1. **No workspace metadata**: Workspace packages are invisible in lockfile
2. **No peer dependency info**: peerDependencies from package.json not recorded
3. **No installation metadata**:
   - No file integrity for workspace packages
   - No install scripts metadata
   - No binaries/bin linking info
4. **No package type info**: No indication of dev vs prod vs optional (except in optionalDependencies field)
5. **No resolution metadata**: No info about why a version was chosen or what requested it
6. **No platform-specific variations**: No OS/CPU/engine constraints recorded
7. **No git dependencies**: This test only had registry deps, but git/file/link deps have different formats

## Size and Statistics

- **Total lines**: 3,730 lines
- **Number of packages**: ~315 packages in node_modules
- **File size**: Approximately 150KB

## Parsing Considerations for Bun

1. **Parser must handle**:
   - Multi-line keys (comma-separated version ranges)
   - Quoted strings with escaping
   - Nested indentation (2-space based)
   - UTF-8 encoding
   - YAML-like format but NOT standard YAML (has quirks)

2. **Key parsing**:
   - Split by `, ` to get individual `package@range` pairs
   - Each package can appear in multiple entries
   - Need to build a map: `(package, range) -> resolution`

3. **Version resolution**:
   - When installing, need to check if requested range matches any existing entry
   - May need to deduplicate ranges like Yarn does
   - Need semver range matching algorithm

4. **Workspace handling**:
   - Bun will need to synthesize workspace package info (not in lockfile)
   - Must use package.json from workspace packages directly
   - Need to create symlinks like Yarn does

5. **Hoisting algorithm**:
   - Yarn.lock doesn't specify where packages are installed
   - Bun needs its own hoisting logic
   - Consider: multiple versions of same package

## Example Entry with All Fields

```yaml
"form-data@^4.0.4":
  version "4.0.4"
  resolved "https://registry.yarnpkg.com/form-data/-/form-data-4.0.4.tgz#784cdcce0669a9d68e94d11ac4eea98088edd2c4"
  integrity sha512-KrGhL9Q4zjj0kiUt5OO4Mr/A/jlI2jDYs5eHBpYHPcBEVSiipAvn2Ko2HnPe20rmcuuvMHNdZFp+4IlGTMF0Ow==
  dependencies:
    asynckit "^0.4.0"
    combined-stream "^1.0.8"
    es-set-tostringtag "^2.1.0"
    hasown "^2.0.2"
    mime-types "^2.1.12"
```

## Conclusion

Yarn v1's lockfile format is:

- **Simple**: Flat list of package resolutions
- **Deduplication-friendly**: Multiple ranges can point to one version
- **Workspace-agnostic**: Workspaces not represented
- **Metadata-light**: Only essential installation info (version, URL, integrity)
- **Human-readable**: YAML-like format with consistent indentation

For Bun to support Yarn v1 lockfiles, the main challenges are:

1. Parsing the quasi-YAML format correctly
2. Implementing compatible deduplication logic
3. Handling workspace packages (which aren't in the lockfile)
4. Building the dependency tree from the flat list
5. Implementing compatible hoisting behavior


Types for it fully at packages/bun-types/bun.d.ts:6318-6389